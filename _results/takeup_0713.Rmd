---
title: "Untitled"
output: html_document
date: "2023-04-30"
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = 'D:/04-MLDD/')
# knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
knitr::opts_chunk$set(results = 'hold', fig.show = 'hold', fig.align = 'center')
# rm(list=ls())

```

# setup

```{r}
source('_data/setup.R')

require(DMwR)
require(themis)

```

```{r}
load('_data/_checkpoints/county_catalog_0705.Rdata')
load('_results/county_rfmodel_1981.Rdata')
load('_data/_checkpoints/bg_0417.Rdata')
load('_data/policies_save.Rdata')

polys <- california %>% 
  arrange(NAME) %>%  
  transmute(id = 1:nrow(.), name = NAME, geometry) 

```


```{r}
## clean up & aggregate policies by county
policies.poly <- policies %>%
  transmute(
    floodZone,
    county = str_sub(countyCode, start = 3, end = 5),
    tract = str_sub(censusTract, start = 6),
    policy_start = ymd_hms(policyEffectiveDate),
    policy_end = ymd_hms(policyTerminationDate)) %>%
  filter(complete.cases(.)) %>%
  filter(ymd('2021-10-01') %within% interval(policy_start, policy_end)) %>%
  left_join(california %>% st_drop_geometry %>% select(COUNTYFP,NAME), by = c('county' = 'COUNTYFP')) %>%
  left_join(polys %>% st_drop_geometry %>% select(id,name), by = c('NAME' = 'name')) %>%
  filter(!is.na(id)) %>% 
  mutate(NFHL = grepl('A',floodZone) | grepl('V',floodZone))

```

## make sure numbers make sense at the tract level 

```{r}
hu_bytract <-   
  bg %>% st_drop_geometry %>% 
  transmute(county = COUNTYFP, tract = TRACTCE, pctarea = partarea/area, hu) %>% 
  mutate(hu_in = hu*pctarea, hu_out = hu*(1-pctarea)) %>% 
  group_by(county, tract) %>% 
  summarize(
    hu = Sum(hu), hu_in = round(sum(hu_in)), hu_out = round(sum(hu_out)), 
    .groups = 'drop')

policies_bytract <- policies.poly %>%
  count(county, tract, NFHL) %>% 
  mutate(temp = case_when(NFHL ~ 'policies_in', TRUE ~ 'policies_out')) %>% 
  select(-NFHL) %>% 
  pivot_wider(id_cols = c(county,tract), names_from = temp, values_from = n) %>% 
  mutate(across(starts_with('policies'), ~setNA(.,0)))

```

```{r}
takeup_in <- Sum(policies_bytract$policies_in) / Sum(hu_bytract$hu_in)
takeup_out <- Sum(policies_bytract$policies_out) / Sum(hu_bytract$hu_out)

bg %>% st_drop_geometry %>% 
  transmute(county = COUNTYFP, tract = TRACTCE, pctarea = partarea/area, hu) %>% 
  mutate(
    hu_in = hu*pctarea, hu_out = hu*(1-pctarea),
    exp_in = takeup_in*hu_in, exp_out = takeup_out*hu_out) %>% 
  summarize(exp_in = sum(exp_in), exp_out = sum(exp_out)) %>% sum
Sum(policies_bytract$policies_in) + Sum(policies_bytract$policies_out)

```

```{r}
takeup_bytract <- bg %>% st_drop_geometry %>%
  transmute(county = COUNTYFP, tract = TRACTCE, pctarea = partarea/area, hu) %>% 
  mutate(
    hu_in = hu*pctarea, hu_out = hu*(1-pctarea),
    exp_in = takeup_in*hu_in, exp_out = takeup_out*hu_out) %>% 
  group_by(county, tract) %>% 
  summarize(
    hu = Sum(hu), hu_in = round(sum(hu_in)), hu_out = hu-hu_in,
    exp_in = round(sum(exp_in)), exp_out = round(sum(exp_out)), .groups = 'drop') %>% 
  full_join(policies_bytract, by = c('county', 'tract')) %>% 
  mutate(across(c(ends_with('in'), ends_with('out')), ~setNA(.,0))) 
takeup_bytract %>% summarize(across(c(ends_with('in'), ends_with('out')), Sum))

```

```{r}
g1 <- ggplot(takeup_bytract) + 
  geom_point(aes(x = policies_in, y = exp_in), alpha = 0.25) + 
  scale_x_origin() + scale_y_origin() +
  geom_parity() + 
  ggtitle(waiver(), subtitle = 'Within NFHL') + 
  labs(x = 'Observed', y = 'Expected') + 
  theme(panel.grid.major = element_line(size = 0.25))
g2 <- ggplot(takeup_bytract) + 
  geom_point(aes(x = policies_out, y = exp_out), alpha = 0.25) + 
  scale_x_origin() + scale_y_origin() +
  geom_parity() + 
  ggtitle(waiver(), subtitle = 'Outside NFHL') + 
  labs(x = 'Observed', y = 'Expected') + 
  theme(panel.grid.major = element_line(size = 0.25))
g1 + g2 + plot_annotation(title = 'Tract-Level Takeup Rates')
# ggsave('_figures/takeup_tract.png', width = 6, height = 3.5)

# g1 <- ggplot(takeup_bytract %>% filter(county == '067')) + 
#   geom_point(aes(x = policies_in, y = jitter(exp_in)), alpha = 0.25) + 
#   scale_x_origin() + scale_y_origin() +
#   geom_parity() + 
#   ggtitle(waiver(), subtitle = 'Within NFHL') + 
#   labs(x = 'Observed', y = 'Expected') + 
#   theme(panel.grid.major = element_line(size = 0.25))
# g2 <- ggplot(takeup_bytract %>% filter(county == '067')) + 
#   geom_point(aes(x = policies_out, y = jitter(exp_out)), alpha = 0.25) + 
#   scale_x_origin() + scale_y_origin() +
#   geom_parity() + 
#   ggtitle(waiver(), subtitle = 'Outside NFHL') + 
#   labs(x = 'Observed', y = 'Expected') + 
#   theme(panel.grid.major = element_line(size = 0.25))
# g1 + g2 + plot_annotation(
#   title = 'Tract-Level Takeup Rates (Sacramento Only)',
#   subtitle = 'Statewide Expected Takeup')
# ggsave('_figures/takeup_sac1.png', width = 6, height = 3.5)

```

## redo at county level

```{r}
hu_bycounty <- 
  bg %>% st_drop_geometry %>% 
  transmute(county = COUNTYFP, pctarea = partarea/area, hu) %>% 
  mutate(hu_in = hu*pctarea, hu_out = hu*(1-pctarea)) %>% 
  group_by(county) %>% 
  summarize(
    hu = Sum(hu), hu_in = round(sum(hu_in)), hu_out = round(sum(hu_out)), 
    .groups = 'drop')

policies_bycounty <- 
  policies.poly %>%
  count(county, NFHL) %>% 
  mutate(temp = case_when(NFHL ~ 'policies_in', TRUE ~ 'policies_out')) %>% 
  select(-NFHL) %>% 
  pivot_wider(id_cols = county, names_from = temp, values_from = n) %>% 
  mutate(across(starts_with('policies'), ~setNA(.,0)))

takeup_in <- Sum(policies_bycounty$policies_in) / Sum(hu_bycounty$hu_in)
takeup_out <- Sum(policies_bycounty$policies_out) / Sum(hu_bycounty$hu_out)

# (Sum(policies_bycounty$policies_in)+Sum(policies_bycounty$policies_out)) / 
#   (Sum(hu_bycounty$hu_in)+Sum(hu_bycounty$hu_out))
# nrow(policies.poly) / Sum(bg$hu)

takeup_bycounty <- 
  bg %>% st_drop_geometry %>%
  transmute(county = COUNTYFP, pctarea = partarea/area, hu) %>% 
  mutate(
    hu_in = hu*pctarea, hu_out = hu*(1-pctarea),
    exp_in = takeup_in*hu_in, exp_out = takeup_out*hu_out) %>% 
  group_by(county) %>% 
  summarize(
    hu = Sum(hu), hu_in = round(Sum(hu_in)), hu_out = hu-hu_in,
    exp_in = round(Sum(exp_in)), exp_out = round(Sum(exp_out)), 
    .groups = 'drop') %>% 
  full_join(policies_bycounty, by = 'county') %>% 
  mutate(across(c(ends_with('in'), ends_with('out')), ~setNA(.,0))) %>% 
  left_join(
    california %>% st_drop_geometry %>% select(NAME,COUNTYFP), 
    by = c('county' = 'COUNTYFP')) %>% 
  mutate(hu = hu_in+hu_out, policies = policies_in+policies_out, exp = exp_in+exp_out) %>%
  mutate(takeup_obs = policies/hu, takeup_exp = exp/hu)
takeup_bycounty %>% summarize(across(c(ends_with('in'), ends_with('out')), Sum))

```

```{r}
g1 <- ggplot(takeup_bycounty) + 
  geom_ribbon(
    data = data.frame(x = (0:(max(takeup_bycounty$takeup_exp+0.01)*1e4))/1e4) %>% 
      mutate(lower = positive(x-0.01), upper = x+0.01),
    aes(x = x, ymin = lower, ymax = upper), fill = 'grey70', alpha = 0.25) + 
  geom_point(aes(x = takeup_exp, y = takeup_obs), size = 1) + 
  geom_text(
    data = takeup_bycounty %>% filter(abs(takeup_exp-takeup_obs) > 0.03),
    aes(x = takeup_exp, y = takeup_obs, label = NAME),
    family = 'Segoe UI', size = 7/.pt, color = 'grey40', 
    nudge_x = 0, nudge_y = -0.005) + 
  scale_x_origin(labels = percent) + scale_y_origin(labels = percent) +
  geom_parity() + coord_cartesian(xlim = range(takeup_bycounty$takeup_exp)) + 
  labs(x = 'Expected Takeup Rate', y = 'Observed Takeup Rate') + 
  theme(panel.grid.major = element_line(size = 0.25))
g2 <- ggplot(takeup_bycounty) + 
  geom_ribbon(
    data = data.frame(x = 10*(1:(max(takeup_bycounty$exp)/10+1e3))) %>% 
      mutate(half = x/2, double = x*2),
    aes(x = x, ymin = half, ymax = double), fill = 'grey70', alpha = 0.25) + 
  geom_text(
    data = takeup_bycounty %>% filter(policies/exp > 5),
    aes(x = exp, y = policies*1.45, label = NAME),
    family = 'Segoe UI', size = 7/.pt, color = 'grey40', 
    nudge_x = 0, nudge_y = 0) + 
  geom_text(
    data = takeup_bycounty %>% filter(exp/policies > 5),
    aes(x = exp, y = (policies+c(0,1.5,0,0))/1.35, label = NAME),
    family = 'Segoe UI', size = 7/.pt, color = 'grey40', 
    nudge_x = c(0.15,0,0,0,0), nudge_y = c(0,0,0,0,0)) + 
  geom_point(aes(x = exp, y = policies), size = 1) + 
  scale_x_log10(labels = comma) + scale_y_log10(labels = comma) + 
  annotation_logticks(sides = 'bl', size = 0.25, color = 'grey25') + 
  geom_parity() + coord_fixed(clip = 'off', xlim = range(takeup_bycounty$exp)) + 
  labs(x = 'Expected Number of Policies', y = 'Observed Number of Policies') + 
  theme(panel.grid.major = element_line(size = 0.25))
g2 + g1 + 
  plot_layout(widths = c(1,1)) + 
  plot_annotation(
    # title = 'County-Level Takeup Rates',
    tag_levels = 'a', tag_prefix = '(', tag_suffix = ')') &
  theme(
    plot.tag = element_text(size = 10, face = 'bold'),
    plot.tag.position = c(0,1))
ggsave('_figures/fig6_takeup.png', width = 6, height = 3.5)

```

## get some stats

```{r}
policies_bycounty %>% 
  full_join(california %>% st_drop_geometry %>% select(COUNTYFP,NAME), by = c('county' = 'COUNTYFP')) %>% 
  mutate(policies = setNA(policies_in + policies_out, 0)) %>% 
  arrange(policies)

```

