---
title: "Untitled"
output: html_document
date: "2023-06-14"
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = 'D:/04-MLDD/')
# knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
knitr::opts_chunk$set(results = 'hold', fig.show = 'hold', fig.align = 'center')
# rm(list=ls())

```

# setup

## load packages & functions 

```{r}
source('_data/setup.R')

suppressPackageStartupMessages({
  require(randomForest)
  require(pdp)
  require(BAMMtools)
  require(pROC)
  require(PRROC)
  require(ggbeeswarm)
  require(iml)
})

label_wrap <- function(variable, value) {
  lapply(strwrap(as.character(value), width=25, simplify=FALSE), paste, collapse="\n")
}

theme_set(theme_classic() + theme(text = element_text(family = 'Segoe UI', size = 9)))

transfm <- function(df, xname) df %>% 
  mutate(x = if(grepl('log', xname)) 10^get(xname)-1 else get(xname))

# colors.hev <- scico(5, palette = 'lajolla')[2:4]
colors.hev <- scico(8, palette = 'lapaz')[c(7,5,3)]
# colors.hev <- c(
#   rgb(242,168,168, maxColorValue = 255), 
#   rgb(164,24,24, maxColorValue = 255),
#   rgb(75,13,13, maxColorValue = 255))

ctycol <- scico(7,palette='roma')[2]
saccol <- roma.colors[5]

```

## load sherlock data

```{r}
nsamp <- 500

```


### statewide

```{r}
## 1981 - all variables

load('_results/county_rfmodel_1981.Rdata')
f.cty.1981 <- f.rf
df.pca.cty.1981 <- df.pca
df.test.cty.1981 <- df.test
obs.cty.1981 <- obs.id
samp.cty.1981 <- sample(1:nrow(df.pca.cty.1981), nsamp)

load(paste0('_results/county_iml_1981.Rdata'))
ale.cty.1981 <- iml.ale
load(paste0('_results/county_shap_1981.Rdata'))
shap.cty.1981 <- shap

```

```{r}
## 2009 - all variables

load('_results/county_rfmodel_2009.Rdata')
f.cty.2009 <- f.rf
df.pca.cty.2009 <- df.pca
df.test.cty.2009 <- df.test
obs.cty.2009 <- obs.id
samp.cty.2009 <- sample(1:nrow(df.pca.cty.2009), nsamp)

load(paste0('_results/county_iml_2009.Rdata'))
ale.cty.2009 <- iml.ale
load(paste0('_results/county_shap_2009.Rdata'))
shap.cty.2009 <- shap

```

```{r}
## 1981 - hazard variables only

load('_results/county_rfmodel_1981_haz.Rdata')
f.cty.haz.1981 <- f.rf
df.pca.cty.haz.1981 <- df.pca
df.test.cty.haz.1981 <- df.test
obs.cty.haz.1981 <- obs.id
samp.cty.haz.1981 <- sample(1:nrow(df.pca.cty.haz.1981), nsamp)

load(paste0('_results/county_iml_1981_haz.Rdata'))
ale.cty.haz.1981 <- iml.ale
load(paste0('_results/county_shap_1981_haz.Rdata'))
shap.cty.haz.1981 <- shap

```

```{r}
## 2009 - hazard variables only

load('_results/county_rfmodel_2009_haz.Rdata')
f.cty.haz.2009 <- f.rf
df.pca.cty.haz.2009 <- df.pca
df.test.cty.haz.2009 <- df.test
obs.cty.haz.2009 <- obs.id
samp.cty.haz.2009 <- sample(1:nrow(df.pca.cty.haz.2009), nsamp)

load(paste0('_results/county_iml_2009_haz.Rdata'))
ale.cty.haz.2009 <- iml.ale
load(paste0('_results/county_shap_2009_haz.Rdata'))
shap.cty.haz.2009 <- shap

```

### Sacramento

```{r}
## 1981 - all variables

load('_results/sac_rfmodel_1981.Rdata')
f.sac.1981 <- f.rf
df.pca.sac.1981 <- df.pca
df.test.sac.1981 <- df.test
obs.sac.1981 <- obs.id
samp.sac.1981 <- sample(1:nrow(df.pca.sac.1981), nsamp)

# load(paste0('_results/sac_iml_1981.Rdata'))
# ale.sac.1981 <- iml.ale
# load(paste0('_results/sac_shap_1981.Rdata'))
# shap.sac.1981 <- shap

```

```{r}
## 2009 - all variables

load('_results/sac_rfmodel_2009.Rdata')
f.sac.2009 <- f.rf
df.pca.sac.2009 <- df.pca
df.test.sac.2009 <- df.test
obs.sac.2009 <- obs.id
samp.sac.2009 <- sample(1:nrow(df.pca.sac.2009), nsamp)

# load(paste0('_results/sac_iml_2009.Rdata'))
# ale.sac.2009 <- iml.ale
# load(paste0('_results/sac_shap_2009.Rdata'))
# shap.sac.2009 <- shap

```

```{r}
## 1981 - hazard variables only

load('_results/sac_rfmodel_1981_haz.Rdata')
f.sac.haz.1981 <- f.rf
df.pca.sac.haz.1981 <- df.pca
df.test.sac.haz.1981 <- df.test
obs.sac.haz.1981 <- obs.id
samp.sac.haz.1981 <- sample(1:nrow(df.pca.sac.haz.1981), nsamp)

# load(paste0('_results/sac_iml_1981_haz.Rdata'))
# ale.sac.haz.1981 <- iml.ale
# load(paste0('_results/sac_shap_1981_haz.Rdata'))
# shap.sac.haz.1981 <- shap

```

```{r}
## 2009 - hazard variables only

load('_results/sac_rfmodel_2009_haz.Rdata')
f.sac.haz.2009 <- f.rf
df.pca.sac.haz.2009 <- df.pca
df.test.sac.haz.2009 <- df.test
obs.sac.haz.2009 <- obs.id
samp.sac.haz.2009 <- sample(1:nrow(df.pca.sac.haz.2009), nsamp)

# load(paste0('_results/sac_iml_2009_haz.Rdata'))
# ale.sac.haz.2009 <- iml.ale
# load(paste0('_results/sac_shap_2009_haz.Rdata'))
# shap.sac.haz.2009 <- shap

```

### remove extraneous variables

```{r}
rm(f.rf, df.pca, df.test, obs.id, iml.ale, shap)

```

# 4.3) Performance Evaluation

## calculate performance metrics

### statewide

```{r}
data.cty.1981 <- 
  predict(f.cty.1981$finalModel, df.test.cty.1981, type = 'prob') %>% 
  as.data.frame %>% 
  transmute(pred = yes, obs = df.test.cty.1981$y) %>% 
  arrange(pred)
metrics.cty.1981 <- 
  foreach (i = (0:100)/100, .combine = 'rbind') %do% {
    caret::confusionMatrix(
      data = factor(ifelse(data.cty.1981$pred > i, 'yes', 'no'), levels = c('no','yes')), 
      reference = data.cty.1981$obs,
      positive = 'yes')$byClass %>% c(i = i)
  } %>% data.frame

pr.auc.cty.1981 <- pr.curve(
  scores.class0 = data.cty.1981$pred, 
  weights.class0 = data.cty.1981$obs=='yes')$auc.integral
roc.auc.cty.1981 <- roc(response = data.cty.1981$obs=='yes', predictor = data.cty.1981$pred)$auc %>% toNumber
stats.cty.1981 <- confusionMatrix(predict(f.cty.1981$finalModel, df.test.cty.1981), df.test.cty.1981$y, positive = 'yes')
stats.cty.1981 <- c(stats.cty.1981$overall, stats.cty.1981$byClass)

```

```{r}
data.cty.2009 <- 
  predict(f.cty.2009$finalModel, df.test.cty.2009, type = 'prob') %>% 
  as.data.frame %>% 
  transmute(pred = yes, obs = df.test.cty.2009$y) %>% 
  arrange(pred)
metrics.cty.2009 <- 
  foreach (i = (0:100)/100, .combine = 'rbind') %do% {
    caret::confusionMatrix(
      data = factor(ifelse(data.cty.2009$pred > i, 'yes', 'no'), levels = c('no','yes')), 
      reference = data.cty.2009$obs,
      positive = 'yes')$byClass %>% c(i = i)
  } %>% data.frame

pr.auc.cty.2009 <- pr.curve(
  scores.class0 = data.cty.2009$pred, 
  weights.class0 = data.cty.2009$obs=='yes')$auc.integral
roc.auc.cty.2009 <- roc(response = data.cty.2009$obs=='yes', predictor = data.cty.2009$pred)$auc %>% toNumber
stats.cty.2009 <- confusionMatrix(predict(f.cty.2009$finalModel, df.test.cty.2009), df.test.cty.2009$y, positive = 'yes')
stats.cty.2009 <- c(stats.cty.2009$overall, stats.cty.2009$byClass)

```

```{r}
data.cty.haz.1981 <- 
  predict(f.cty.haz.1981$finalModel, df.test.cty.haz.1981, type = 'prob') %>% 
  as.data.frame %>% 
  transmute(pred = yes, obs = df.test.cty.haz.1981$y) %>% 
  arrange(pred)
metrics.cty.haz.1981 <- 
  foreach (i = (0:100)/100, .combine = 'rbind') %do% {
    caret::confusionMatrix(
      data = factor(ifelse(data.cty.haz.1981$pred > i, 'yes', 'no'), levels = c('no','yes')), 
      reference = data.cty.haz.1981$obs,
      positive = 'yes')$byClass %>% c(i = i)
  } %>% data.frame

pr.auc.cty.haz.1981 <- pr.curve(
  scores.class0 = data.cty.haz.1981$pred, 
  weights.class0 = data.cty.haz.1981$obs=='yes')$auc.integral
roc.auc.cty.haz.1981 <- roc(response = data.cty.haz.1981$obs=='yes', predictor = data.cty.haz.1981$pred)$auc %>% toNumber
stats.cty.haz.1981 <- confusionMatrix(predict(f.cty.haz.1981$finalModel, df.test.cty.haz.1981), df.test.cty.haz.1981$y, positive = 'yes')
stats.cty.haz.1981 <- c(stats.cty.haz.1981$overall, stats.cty.haz.1981$byClass)

```

```{r}
data.cty.haz.2009 <- 
  predict(f.cty.haz.2009$finalModel, df.test.cty.haz.2009, type = 'prob') %>% 
  as.data.frame %>% 
  transmute(pred = yes, obs = df.test.cty.haz.2009$y) %>% 
  arrange(pred)
metrics.cty.haz.2009 <- 
  foreach (i = (0:100)/100, .combine = 'rbind') %do% {
    caret::confusionMatrix(
      data = factor(ifelse(data.cty.haz.2009$pred > i, 'yes', 'no'), levels = c('no','yes')), 
      reference = data.cty.haz.2009$obs,
      positive = 'yes')$byClass %>% c(i = i)
  } %>% data.frame

pr.auc.cty.haz.2009 <- pr.curve(
  scores.class0 = data.cty.haz.2009$pred, 
  weights.class0 = data.cty.haz.2009$obs=='yes')$auc.integral
roc.auc.cty.haz.2009 <- roc(response = data.cty.haz.2009$obs=='yes', predictor = data.cty.haz.2009$pred)$auc %>% toNumber
stats.cty.haz.2009 <- confusionMatrix(predict(f.cty.haz.2009$finalModel, df.test.cty.haz.2009), df.test.cty.haz.2009$y, positive = 'yes')
stats.cty.haz.2009 <- c(stats.cty.haz.2009$overall, stats.cty.haz.2009$byClass)

```

### Sacramento

```{r}
data.sac.1981 <- 
  predict(f.sac.1981$finalModel, df.test.sac.1981, type = 'prob') %>% 
  as.data.frame %>% 
  transmute(pred = yes, obs = df.test.sac.1981$y) %>% 
  arrange(pred)
metrics.sac.1981 <- 
  foreach (i = (0:100)/100, .combine = 'rbind') %do% {
    caret::confusionMatrix(
      data = factor(ifelse(data.sac.1981$pred > i, 'yes', 'no'), levels = c('no','yes')), 
      reference = data.sac.1981$obs,
      positive = 'yes')$byClass %>% c(i = i)
  } %>% data.frame

pr.auc.sac.1981 <- pr.curve(
  scores.class0 = data.sac.1981$pred, 
  weights.class0 = data.sac.1981$obs=='yes')$auc.integral
roc.auc.sac.1981 <- roc(response = data.sac.1981$obs=='yes', predictor = data.sac.1981$pred)$auc %>% toNumber
stats.sac.1981 <- confusionMatrix(predict(f.sac.1981$finalModel, df.test.sac.1981), df.test.sac.1981$y, positive = 'yes')
stats.sac.1981 <- c(stats.sac.1981$overall, stats.sac.1981$byClass)

```

```{r}
data.sac.2009 <- 
  predict(f.sac.2009$finalModel, df.test.sac.2009, type = 'prob') %>% 
  as.data.frame %>% 
  transmute(pred = yes, obs = df.test.sac.2009$y) %>% 
  arrange(pred)
metrics.sac.2009 <- 
  foreach (i = (0:100)/100, .combine = 'rbind') %do% {
    caret::confusionMatrix(
      data = factor(ifelse(data.sac.2009$pred > i, 'yes', 'no'), levels = c('no','yes')), 
      reference = data.sac.2009$obs,
      positive = 'yes')$byClass %>% c(i = i)
  } %>% data.frame

pr.auc.sac.2009 <- pr.curve(
  scores.class0 = data.sac.2009$pred, 
  weights.class0 = data.sac.2009$obs=='yes')$auc.integral
roc.auc.sac.2009 <- roc(response = data.sac.2009$obs=='yes', predictor = data.sac.2009$pred)$auc %>% toNumber
stats.sac.2009 <- confusionMatrix(predict(f.sac.2009$finalModel, df.test.sac.2009), df.test.sac.2009$y, positive = 'yes')
stats.sac.2009 <- c(stats.sac.2009$overall, stats.sac.2009$byClass)

```

```{r}
data.sac.haz.1981 <- 
  predict(f.sac.haz.1981$finalModel, df.test.sac.haz.1981, type = 'prob') %>% 
  as.data.frame %>% 
  transmute(pred = yes, obs = df.test.sac.haz.1981$y) %>% 
  arrange(pred)
metrics.sac.haz.1981 <- 
  foreach (i = (0:100)/100, .combine = 'rbind') %do% {
    caret::confusionMatrix(
      data = factor(ifelse(data.sac.haz.1981$pred > i, 'yes', 'no'), levels = c('no','yes')), 
      reference = data.sac.haz.1981$obs,
      positive = 'yes')$byClass %>% c(i = i)
  } %>% data.frame

pr.auc.sac.haz.1981 <- pr.curve(
  scores.class0 = data.sac.haz.1981$pred, 
  weights.class0 = data.sac.haz.1981$obs=='yes')$auc.integral
roc.auc.sac.haz.1981 <- roc(response = data.sac.haz.1981$obs=='yes', predictor = data.sac.haz.1981$pred)$auc %>% toNumber
stats.sac.haz.1981 <- confusionMatrix(predict(f.sac.haz.1981$finalModel, df.test.sac.haz.1981), df.test.sac.haz.1981$y, positive = 'yes')
stats.sac.haz.1981 <- c(stats.sac.haz.1981$overall, stats.sac.haz.1981$byClass)

```

```{r}
data.sac.haz.2009 <- 
  predict(f.sac.haz.2009$finalModel, df.test.sac.haz.2009, type = 'prob') %>% 
  as.data.frame %>% 
  transmute(pred = yes, obs = df.test.sac.haz.2009$y) %>% 
  arrange(pred)
metrics.sac.haz.2009 <- 
  foreach (i = (0:100)/100, .combine = 'rbind') %do% {
    caret::confusionMatrix(
      data = factor(ifelse(data.sac.haz.2009$pred > i, 'yes', 'no'), levels = c('no','yes')), 
      reference = data.sac.haz.2009$obs,
      positive = 'yes')$byClass %>% c(i = i)
  } %>% data.frame

pr.auc.sac.haz.2009 <- pr.curve(
  scores.class0 = data.sac.haz.2009$pred, 
  weights.class0 = data.sac.haz.2009$obs=='yes')$auc.integral
roc.auc.sac.haz.2009 <- roc(response = data.sac.haz.2009$obs=='yes', predictor = data.sac.haz.2009$pred)$auc %>% toNumber
stats.sac.haz.2009 <- confusionMatrix(predict(f.sac.haz.2009$finalModel, df.test.sac.haz.2009), df.test.sac.haz.2009$y, positive = 'yes')
stats.sac.haz.2009 <- c(stats.sac.haz.2009$overall, stats.sac.haz.2009$byClass)

```

## new figure

```{r}
stats.all <- 
  rbind(
    data.frame(t(stats.cty.1981)) %>% cbind(spat = 'Statewide', temp = '1981-2021', var = 'All Variables'),
    data.frame(t(stats.cty.2009)) %>% cbind(spat = 'Statewide', temp = '2009-2021', var = 'All Variables'),
    data.frame(t(stats.cty.haz.1981)) %>% cbind(spat = 'Statewide', temp = '1981-2021', var = 'Hazard Only'),
    data.frame(t(stats.cty.haz.2009)) %>% cbind(spat = 'Statewide', temp = '2009-2021', var = 'Hazard Only'),
    data.frame(t(stats.sac.1981)) %>% cbind(spat = 'Sacramento', temp = '1981-2021', var = 'All Variables'),
    data.frame(t(stats.sac.2009)) %>% cbind(spat = 'Sacramento', temp = '2009-2021', var = 'All Variables'),
    data.frame(t(stats.sac.haz.1981)) %>% cbind(spat = 'Sacramento', temp = '1981-2021', var = 'Hazard Only'),
    data.frame(t(stats.sac.haz.2009)) %>% cbind(spat = 'Sacramento', temp = '2009-2021', var = 'Hazard Only')) %>% 
  select(Accuracy, Sensitivity, Specificity, Precision, Recall, Balanced.Accuracy, spat, temp, var) %>% 
  mutate(
    PR.AUC = c(
      pr.auc.cty.1981, pr.auc.cty.2009, pr.auc.cty.haz.1981, pr.auc.cty.haz.2009,
      pr.auc.sac.1981, pr.auc.sac.2009, pr.auc.sac.haz.1981, pr.auc.sac.haz.2009),
    ROC.AUC = c(
      roc.auc.cty.1981, roc.auc.cty.2009, roc.auc.cty.haz.1981, roc.auc.cty.haz.2009,
      roc.auc.sac.1981, roc.auc.sac.2009, roc.auc.sac.haz.1981, roc.auc.sac.haz.2009),
    PR.null = c(
      sum(df.test.cty.1981$y=='yes')/nrow(df.test.cty.1981),
      sum(df.test.cty.2009$y=='yes')/nrow(df.test.cty.2009),
      sum(df.test.cty.haz.1981$y=='yes')/nrow(df.test.cty.haz.1981),
      sum(df.test.cty.haz.2009$y=='yes')/nrow(df.test.cty.haz.2009),
      sum(df.test.sac.1981$y=='yes')/nrow(df.test.sac.1981),
      sum(df.test.sac.2009$y=='yes')/nrow(df.test.sac.2009),
      sum(df.test.sac.haz.1981$y=='yes')/nrow(df.test.sac.haz.1981),
      sum(df.test.sac.haz.2009$y=='yes')/nrow(df.test.sac.haz.2009)),
    ROC.null = rep(0.5,8),
    Balanced.null = rep(0.5,8))

```


```{r}
metrics.all <- 
  rbind(
    metrics.cty.1981 %>% mutate(spat = 'Statewide', temp = '1981-2021', var = 'All Variables'),
    metrics.cty.2009 %>% mutate(spat = 'Statewide', temp = '2009-2021', var = 'All Variables'),
    metrics.cty.haz.1981 %>% mutate(spat = 'Statewide', temp = '1981-2021', var = 'Hazard Only'),
    metrics.cty.haz.2009 %>% mutate(spat = 'Statewide', temp = '2009-2021', var = 'Hazard Only'),
    metrics.sac.1981 %>% mutate(spat = 'Sacramento', temp = '1981-2021', var = 'All Variables'),
    metrics.sac.2009 %>% mutate(spat = 'Sacramento', temp = '2009-2021', var = 'All Variables'),
    metrics.sac.haz.1981 %>% mutate(spat = 'Sacramento', temp = '1981-2021', var = 'Hazard Only'),
    metrics.sac.haz.2009 %>% mutate(spat = 'Sacramento', temp = '2009-2021', var = 'Hazard Only')) 

ggplot() + 
  geom_hline(yintercept = 0) + geom_vline(xintercept = 0) + 
  geom_hline(data = stats.all, aes(yintercept = PR.null), linetype = 'dashed', color = 'grey50') + 
  geom_line(data = metrics.all, aes(x = Recall, y = Precision, group = var, color = var), size = 0.75) + 
  geom_point(data = stats.all, aes(x = Recall, y = Precision, group = var, color = var), size = 2) +
  facet_grid(temp ~ spat) + 
  scale_color_manual(values = c('black', 'grey70')) + 
  scale_x_continuous(limits = c(0,1), expand = expansion(mult = c(0,0.01))) + 
  scale_y_continuous(limits = c(0,1), expand = expansion(mult = c(0,0.01))) + 
  coord_fixed() + 
  theme(
    panel.grid.major = element_line(size = 0.25),
    strip.background = element_rect(color = NA, fill = 'grey95'),
    panel.spacing = unit(20, 'pt'),
    strip.placement = 'outside')

ggplot() + 
  geom_abline(slope = 1, intercept = 1, linetype = 'dashed', color = 'grey50') + 
  geom_hline(yintercept = 0) + geom_vline(xintercept = 1) + 
  geom_line(data = metrics.all, aes(x = Specificity, y = Sensitivity, group = var, color = var), size = 0.75) + 
  geom_point(data = stats.all, aes(x = Specificity, y = Sensitivity, group = var, color = var), size = 2) +
  facet_grid(temp ~ spat) + 
  scale_color_manual(values = c('black', 'grey70')) + 
  scale_x_reverse(limits = c(1,0), expand = expansion(mult = c(0,0.01))) + 
  scale_y_continuous('Sensitivity (Recall)', limits = c(0,1), expand = expansion(mult = c(0,0.01))) + 
  coord_fixed() + 
  theme(
    panel.grid.major = element_line(size = 0.25),
    strip.background = element_rect(color = NA, fill = 'grey95'),
    panel.spacing = unit(20, 'pt'))

```

## TABLE 2: Model performance results

```{r}
stats.all %>% 
  select(spat, temp, var, PR.AUC, PR.null, ROC.AUC, ROC.null, Balanced.Accuracy, Balanced.null) %>% 
  pivot_wider(names_from = var, values_from = c(starts_with('PR'), starts_with('ROC'), starts_with('Balanced'))) %>% 
  select(-contains('null_Hazard')) %>% 
  gt %>% 
  fmt_number(c(starts_with('PR'), starts_with('ROC'), starts_with('Balanced')), decimals = 3) %>% 
  cols_label(
    spat = 'Spatial Res.',
    temp = 'Temporal Res.',
    `PR.AUC_All Variables` = 'PRAUC-AllVar',
    `PR.AUC_Hazard Only` = 'PRAUC-HazVar',
    `PR.null_All Variables` = 'PRAUC-Null',
    `ROC.AUC_All Variables` = 'ROCAUC-AllVar',
    `ROC.AUC_Hazard Only` = 'ROCAUC-HazVar',
    `ROC.null_All Variables` = 'ROCAUC-Null',
    `Balanced.Accuracy_All Variables` = 'BalAcc-AllVar',
    `Balanced.Accuracy_Hazard Only` = 'BalAcc-HazVar',
    `Balanced.null_All Variables` = 'BalAcc-Null')
  
```

## FIG 1: Calculation of model performance metrics

```{r}
rbind(
  metrics.cty %>% mutate(spat = 'Statewide', temp = 'All Years'),
  metrics.cty09 %>% mutate(spat = 'Statewide', temp = '2009--'),
  metrics.sac %>% mutate(spat = 'Sacramento', temp = 'All Years'),
  metrics.sac09 %>% mutate(spat = 'Sacramento', temp = '2009--')) %>% 
  mutate(xlab = paste(spat, temp, sep = '\n')) %>% 
  ggplot() + 
  geom_hline(
    aes(
      yintercept = sum(df.test.sac$y=='yes')/nrow(df.test.sac), 
      color = 'Sacramento', alpha = 'All Years'), 
    linetype = 'dashed', show.legend = FALSE) + 
  geom_hline(
    aes(
      yintercept = sum(df.test.cty$y=='yes')/nrow(df.test.cty), 
      color = 'Statewide', alpha = 'All Years'), 
    linetype = 'dashed', show.legend = FALSE) + 
  geom_hline(
    aes(
      yintercept = sum(df.test.sac09$y=='yes')/nrow(df.test.sac09), 
      color = 'Sacramento', alpha = '2009--'), 
    linetype = 'dashed', show.legend = FALSE) + 
  geom_hline(
    aes(
      yintercept = sum(df.test.cty09$y=='yes')/nrow(df.test.cty09), 
      color = 'Statewide', alpha = '2009--'), 
    linetype = 'dashed', show.legend = FALSE) + 
  geom_line(aes(x = Recall, y = Precision, group = xlab, color = spat, alpha = temp)) + 
  scale_x_continuous(limits = c(0,1), expand = expansion(mult = c(0,0.01))) + 
  scale_y_continuous(limits = c(0,1), expand = expansion(mult = c(0,0.01))) + 
  scale_color_manual('Spatial\nResolution', values = c(saccol, ctycol)) +
  scale_alpha_manual('Temporal\nResolution', values = c(0.4,1)) + 
  guides(
    color = guide_legend(override.aes = list(size = 1)), 
    alpha = guide_legend(override.aes = list(size = 1, alpha = c(0.25,1)))) + 
  coord_fixed(clip = 'off') + 
  theme(
    text = element_text(family = 'Segoe UI', size = 9),
    panel.grid.major = element_line(size = 0.35), 
    legend.position = 'bottom')

```

```{r}
prauc.line <- 
  rbind(
    metrics.cty %>% mutate(spat = 'Statewide', temp = 'All Years'),
    metrics.cty09 %>% mutate(spat = 'Statewide', temp = '2009--'),
    metrics.sac %>% mutate(spat = 'Sacramento', temp = 'All Years'),
    metrics.sac09 %>% mutate(spat = 'Sacramento', temp = '2009--')) %>% 
    mutate(xlab = paste(spat, temp, sep = '\n'))
prauc.null <- 
  rbind(
    c(yint = sum(df.test.sac$y=='yes')/nrow(df.test.sac), spat = 'Sacramento', temp = 'All Years'),
    c(yint = sum(df.test.cty$y=='yes')/nrow(df.test.cty), spat = 'Statewide', temp = 'All Years'),
    c(yint = sum(df.test.sac09$y=='yes')/nrow(df.test.sac09), spat = 'Sacramento', temp = '2009--'),
    c(yint = sum(df.test.cty09$y=='yes')/nrow(df.test.cty09), spat = 'Statewide', temp = '2009--')) %>% 
  data.frame %>% mutate(yint = toNumber(yint))
prauc.point <- 
  rbind(
    c(x = stats.cty['Recall'], y = stats.cty['Precision'], spat = 'Statewide', temp = 'All Years'),
    c(x = stats.sac['Recall'], y = stats.sac['Precision'], spat = 'Sacramento', temp = 'All Years'),
    c(x = stats.cty09['Recall'], y = stats.cty09['Precision'], spat = 'Statewide', temp = '2009--'),
    c(x = stats.sac09['Recall'], y = stats.sac09['Precision'], spat = 'Sacramento', temp = '2009--')) %>% 
  data.frame %>% mutate(x = toNumber(x.Recall), y = toNumber(y.Precision))
g1 <- ggplot() + 
  geom_hline(
    data = prauc.null,
    aes(yintercept = yint, color = spat, alpha = temp), 
    linetype = 'dashed', show.legend = FALSE) + 
  geom_line(
    data = prauc.line, 
    aes(x = Recall, y = Precision, group = xlab, color = spat, alpha = temp), 
    size = 0.75) + 
  geom_point(
    data = prauc.point, 
    aes(x = x, y = y, color = spat, alpha = temp),
     size = 2, show.legend = FALSE) + 
  scale_x_continuous(limits = c(0,1), expand = expansion(mult = c(0,0.01))) + 
  scale_y_continuous(limits = c(0,1), expand = expansion(mult = c(0,0.01))) + 
  scale_color_manual('Spatial\nResolution', values = c(saccol, ctycol)) +
  scale_alpha_manual('Temporal\nResolution', values = c(0.4,1)) + 
  guides(
    color = guide_legend(override.aes = list(size = 1)), 
    alpha = guide_legend(override.aes = list(size = 1, alpha = c(0.25,1)))) + 
  coord_fixed(clip = 'off') + 
  theme(
    text = element_text(family = 'Segoe UI', size = 9),
    panel.grid.major = element_line(size = 0.35), 
    legend.position = 'bottom')

rocauc.line <- 
  rbind(
    metrics.cty %>% select(1:2) %>% rbind(c(Sensitivity = 1, Specificity = 0)) %>% 
      mutate(spat = 'Statewide', temp = 'All Years'),
    metrics.cty09 %>% select(1:2) %>% rbind(c(Sensitivity = 1, Specificity = 0)) %>% 
      mutate(spat = 'Statewide', temp = '2009--'),
    metrics.sac %>% select(1:2) %>% rbind(c(Sensitivity = 1, Specificity = 0)) %>% 
      mutate(spat = 'Sacramento', temp = 'All Years'),
    metrics.sac09 %>% select(1:2) %>% rbind(c(Sensitivity = 1, Specificity = 0)) %>% 
      mutate(spat = 'Sacramento', temp = '2009--')) %>% 
    mutate(xlab = paste(spat, temp, sep = '\n'))
rocauc.point <- 
  rbind(
    c(x = stats.cty['Specificity'], y = stats.cty['Sensitivity'], spat = 'Statewide', temp = 'All Years'),
    c(x = stats.sac['Specificity'], y = stats.sac['Sensitivity'], spat = 'Sacramento', temp = 'All Years'),
    c(x = stats.cty09['Specificity'], y = stats.cty09['Sensitivity'], spat = 'Statewide', temp = '2009--'),
    c(x = stats.sac09['Specificity'], y = stats.sac09['Sensitivity'], spat = 'Sacramento', temp = '2009--')) %>% 
  data.frame %>% mutate(x = toNumber(x.Specificity), y = toNumber(y.Sensitivity))
g2 <- ggplot() + 
  geom_line(
    data = rocauc.line,
    aes(x = Specificity, y = Sensitivity, color = spat, alpha = temp), 
    size = 0.75) +
  geom_point(
    data = rocauc.point,
    aes(x = x, y = y, color = spat, alpha = temp),
    size = 2) + 
  scale_x_reverse(limits = c(1,0), expand = expansion(mult = c(0,0.01))) + 
  scale_y_continuous('Sensitivity (Recall)', limits = c(0,1), expand = expansion(mult = c(0,0.01))) + 
  geom_abline(slope = 1, intercept = 1, linetype = 'dashed') + 
  scale_color_manual('Spatial\nResolution', values = c(saccol, ctycol)) +
  scale_alpha_manual('Temporal\nResolution', values = c(0.4,1)) + 
  coord_fixed(clip = 'off') + 
  theme(
    text = element_text(family = 'Segoe UI', size = 9),
    panel.grid.major = element_line(size = 0.25), 
    legend.position = 'none')

g1 + g2 + guide_area() + 
  plot_layout(design = 'ab\ncc', heights = c(100,1), guides = 'collect') + 
  plot_annotation(tag_levels = 'a', tag_prefix = '(', tag_suffix = ')') & 
  theme(
    legend.background = element_blank(),
    plot.tag = element_text(face = 'bold'), legend.box = 'horizontal')
ggsave('_figures/fig1_performance.png', width = 6, height = 3)

```

# 5.2) Variable Importance

## new figure

```{r}
plotimp.cty.1981 <- shap.cty.1981 %>% 
  as.data.frame %>% select(-y) %>% 
  summarize(across(everything(), ~mean(abs(.)))) %>% 
  pivot_longer(everything(), names_to = 'varnames', values_to = 'shap') %>% 
  left_join(dimension, by = c('varnames' = 'var')) %>% 
  arrange(shap) %>% 
  filter(shap >= shap[varnames=='noise']) %>% 
  mutate(
    rank = nrow(.):1,
    varnames = factor(varnames, levels = varnames),
    fullname = factor(fullname, levels = fullname),
    shap = c(0, shap[-1]),
    # shap = shap/sum(shap),
    dim = factor(dim, levels = c('H','E','V')))
plotimp.cty.2009 <- shap.cty.2009 %>% 
  as.data.frame %>% select(-y) %>% 
  summarize(across(everything(), ~mean(abs(.)))) %>% 
  pivot_longer(everything(), names_to = 'varnames', values_to = 'shap') %>% 
  left_join(dimension, by = c('varnames' = 'var')) %>% 
  arrange(shap) %>% 
  filter(shap >= shap[varnames=='noise']) %>% 
  mutate(
    rank = nrow(.):1,
    varnames = factor(varnames, levels = varnames),
    fullname = factor(fullname, levels = fullname),
    shap = c(0, shap[-1]),
    # shap = shap/sum(shap),
    dim = factor(dim, levels = c('H','E','V')))

rbind(
  plotimp.cty.1981 %>% mutate(spat = 'Statewide', temp = '1981-2021'),
  plotimp.cty.2009 %>% mutate(spat = 'Statewide', temp = '2009-2021')) %>% 
  mutate(shap = setNA(shap,0)) %>%
  pivot_wider(names_from = c(spat,temp), values_from = c(shap,rank)) %>% 
  mutate(
    across(starts_with('shap'), ~setNA(.,0)),
    across(starts_with('rank'), ~setNA(.,30))) %>%
  mutate(totalrank = select(., starts_with('rank')) %>% apply(1,sum)) %>% 
  pivot_longer(
    cols = c(starts_with('rank'), starts_with('shap')), 
    names_to = c('shaprank', 'spat', 'temp'), names_sep = '_') %>% 
  pivot_wider(names_from = shaprank, values_from = value) %>% 
  arrange(desc(totalrank)) %>% 
  mutate(
    fullname = factor(fullname, levels = unique(fullname)),
    xname = paste(spat,temp,sep = '\n')) %>% 
  filter(varnames != 'noise') %>% 
  ggplot() + 
  geom_tile(
    aes(x = xname, y = fullname, fill = shap), 
    width = 0.9) + 
  geom_text(
    aes(x = xname[1], y = fullname, label = dim, color = dim),
    family = 'Segoe UI', size = 9/.pt, fontface = 'bold', nudge_x = -0.575,
    show.legend = FALSE) + 
  scale_color_manual(values = colors.hev) + 
  ggnewscale::new_scale_color() + 
  geom_text(
    aes(x = xname, y = fullname, label = rank, color = rank<=5|rank>=30),
    family = 'Segoe UI', size = 8/.pt,
    show.legend = FALSE) + 
  scale_color_manual(values = c('black','white')) + 
  scale_fill_scico(
    'SHAP Feature\nContribution', 
    palette = 'davos', direction = -1, label = percent) + 
  scale_x_discrete(position = 'top', expand = expansion(mult = c(0.65,0.6))) + 
  scale_y_discrete(expand = expansion(0.035)) + 
  theme(
    axis.title = element_blank(), 
    axis.text = element_text(size = 9, color = 'black'),
    axis.line = element_blank(),
    panel.background = element_rect(fill = 'white', color = 'grey70'))

rbind(
  plotimp.cty.1981 %>% mutate(spat = 'Statewide', temp = '1981-2021'),
  plotimp.cty.2009 %>% mutate(spat = 'Statewide', temp = '2009-2021')) %>% 
  ggplot() + 
  geom_line(aes(x = paste(spat,temp,sep = '\n'), y = shap, group = varnames))

```


## FIG 2: SHAP global feature importance

```{r}
shap.plot.cty <- shap.cty %>% 
  as.data.frame %>% select(-y) %>% 
  summarize(across(everything(), ~mean(abs(.)))) %>% 
  pivot_longer(everything(), names_to = 'varnames', values_to = 'shap') %>% 
  left_join(dimension, by = c('varnames' = 'var')) %>% 
  arrange(shap) %>% 
  mutate(
    varnames = factor(varnames, levels = varnames),
    fullname = factor(fullname, levels = fullname),
    dim = factor(dim, levels = c('H','E','V')))
shap.plot.sac <- shap.sac %>% 
  as.data.frame %>% select(-y) %>% 
  summarize(across(everything(), ~mean(abs(.)))) %>% 
  pivot_longer(everything(), names_to = 'varnames', values_to = 'shap') %>% 
  left_join(dimension, by = c('varnames' = 'var')) %>% 
  arrange(shap) %>% 
  mutate(
    varnames = factor(varnames, levels = varnames),
    fullname = factor(fullname, levels = fullname),
    dim = factor(dim, levels = c('H','E','V')))

shap.plot.cty09 <- shap.cty09 %>% 
  as.data.frame %>% select(-y) %>% 
  summarize(across(everything(), ~mean(abs(.)))) %>% 
  pivot_longer(everything(), names_to = 'varnames', values_to = 'shap') %>% 
  left_join(
    dimension %>% rbind(c(dim = 'V', var = 'med_age', fullname = 'Median Structural Age')),
    by = c('varnames' = 'var')) %>% 
  arrange(shap) %>% 
  mutate(
    varnames = factor(varnames, levels = varnames),
    fullname = factor(fullname, levels = fullname),
    dim = factor(dim, levels = c('H','E','V')))
shap.plot.sac09 <- shap.sac09 %>% 
  as.data.frame %>% select(-y) %>% 
  summarize(across(everything(), ~mean(abs(.)))) %>% 
  pivot_longer(everything(), names_to = 'varnames', values_to = 'shap') %>% 
  left_join(
    dimension %>% rbind(c(dim = 'V', var = 'med_age', fullname = 'Median Structural Age')),
    by = c('varnames' = 'var')) %>% 
  arrange(shap) %>% 
  mutate(
    varnames = factor(varnames, levels = varnames),
    fullname = factor(fullname, levels = fullname),
    dim = factor(dim, levels = c('H','E','V')))

```

```{r}
shap.plot <- 
  rbind(
    shap.plot.cty %>% mutate(spat = 'Statewide', temp = 'All Years'),
    shap.plot.sac %>% mutate(spat = 'Sacramento', temp = 'All Years'),
    shap.plot.cty09 %>% mutate(spat = 'Statewide', temp = '2009--'), 
    shap.plot.sac09 %>% mutate(spat = 'Sacramento', temp = '2009--')) 

temp <- shap.plot %>% 
  group_by(spat,temp,dim,concept) %>% 
  summarize(imptce = Sum(shap)) %>% 
  group_by(spat,temp) %>% 
  mutate(imptce = imptce/sum(imptce)) %>% 
  ungroup
temp <- temp %>% 
  group_by(spat,temp,dim) %>% 
  summarize(imptce.hev = Sum(imptce)) %>% 
  mutate(dim = factor(dim, levels = c('H','E','V'))) %>% 
  arrange(rev(dim)) %>% 
  mutate(
    start = cumsum(imptce.hev), 
    end = c(0, start[-length(dim)]),
    lab = cbind(start,end) %>% apply(1,mean)) %>% 
  ungroup %>% 
  select(-start, -end) %>% 
  left_join(
    temp %>% select(spat,temp,dim,concept,imptce), 
    by = c('spat','temp','dim')) %>%
  group_by(spat,temp,dim) %>% 
  mutate(
    id = 1:length(dim),
    lab = case_when(id==1 ~ lab)) %>% 
  select(-id) %>%
  ungroup %>% 
  group_by(dim) %>% arrange(factor(concept)) %>% 
  mutate(
    conceptid = paste(dim, concept, sep = '-') %>% 
      factor(levels = rev(c(
        'H-ARchar','H-antecedent','H-modes-lsm','E-people','E-housing',
        'V-social','V-infra','V-memory')))) %>% 
  arrange(conceptid) %>% 
  mutate(xlab = paste(spat, temp, sep = '\n')) %>% 
  mutate(xlab = factor(xlab, levels = rev(levels(factor(xlab))))) %>% 
  ungroup

ggplot(temp) + 
  geom_col(
    aes(x = as.numeric(xlab), y = imptce, group = dim),
    width = 0.75, fill = 'white', color = NA) + 
  geom_col(
    aes(x = as.numeric(xlab), y = imptce, group = dim, fill = dim, alpha = conceptid),
    width = 0.75) + 
  geom_col(
    data = temp %>% 
      group_by(spat,temp,dim) %>% 
      summarize(imptce.hev = sum(imptce)) %>% 
      ungroup %>% 
      mutate(dim = factor(dim, levels = c('H','E','V'))) %>% 
      mutate(xlab = paste(spat, temp, sep = '\n')) %>% 
      mutate(xlab = factor(xlab, levels = rev(levels(factor(xlab))))),
    aes(x = as.numeric(xlab), y = imptce.hev, group = dim), 
    width = 0.75, size = 0.25, fill = NA, color = 'grey10') + 
  geom_text(
    aes(x = as.numeric(xlab), y = lab, label = percent(imptce.hev, accuracy=1)),
    family = 'Segoe UI', fontface = 'bold', size = 9/.pt) + 
  geom_text_repel(
    data = temp %>% 
      filter(spat == 'Sacramento' & temp == '2009--') %>% 
      mutate(
        start = cumsum(imptce),
        end = c(0, start[-length(concept)]),
        lab = cbind(start,end) %>% apply(1,mean)) %>% 
      mutate(concept_name = case_match(
        concept, 
        'ARchar' ~ 'AR Characteristics',
        'antecedent' ~ 'Antecedent\nConditions',
        'modes-lsm' ~ 'Climate Modes +\nLand Surface',
        'people' ~ 'Population',
        'housing' ~ 'Housing',
        'social' ~ 'Social Vulnerability',
        'infra' ~ 'Infrastructural\nVulnerability',
        'memory' ~ 'Flood Memory')),
    aes(x = as.numeric(xlab)+0.75/2, y = lab, label = concept_name),
    direction = 'y', min.segment.length = 0,
    family = 'Segoe UI', size = 8/.pt, hjust = 0, nudge_x = 0.225, lineheight = 0.8) + 
  scale_fill_manual(
    'Dimension',
    breaks = c('H','E','V'),
    labels = c('Hazard','Exposure','Vulnerability'),
    values = colors.hev) +
  scale_alpha_manual(
    'Dimension',
    values = c(1,0.8,0.6,1,0.7,1,0.7,0.4),
    guide = guide_none()) +
  scale_x_continuous(
    breaks = 1:4, labels = levels(temp$xlab), 
    expand = expansion(add = c(0.25,1.25))) + 
  scale_y_origin('SHAP Feature Importance') + 
  theme(
    legend.position = 'bottom',
    panel.grid.major.y = element_line(size = 0.25),
    axis.title.x = element_blank())
ggsave('_figures/fig2_imptce.png', width = 6, height = 4)

```

## FIG 3: temporal comparison

```{r}
shap.plot <- shap.plot %>% 
  group_by(spat, temp) %>% 
  arrange(desc(shap)) %>% 
  mutate(rank = (1:length(dim))/length(dim)) %>% 
  ungroup

```


```{r width = 6, height = 6}
plot.cty <- shap.plot %>%
  filter(spat == 'Statewide') %>% 
  select(fullname, temp, rank, dim) %>% 
  pivot_wider(names_from = temp, values_from = rank) %>% 
  filter(complete.cases(.)) %>% 
  pivot_longer(cols = unique(shap.plot$temp), names_to = 'temp', values_to = 'rank') %>% 
  group_by(temp) %>% arrange(rank) %>% 
  mutate(rankpt = (1:length(dim))/length(dim)) %>% ungroup %>%
  mutate(temp = factor(temp, levels = c('All Years', '2009--')))
g1 <- ggplot(plot.cty) +
  geom_line(aes(x = temp, y = rankpt, group = fullname, color = dim), size = 1) +
  geom_text(
    data = plot.cty %>% filter(temp == 'All Years'),
    aes(x = temp, y = rankpt, label = fullname),
    hjust = 1, nudge_x = -0.1, family = 'Segoe UI', size = 6.5/.pt) + 
  scale_y_reverse() +
  scale_x_discrete(expand = expansion(c(3,0.1)), position = 'top') +
  scale_color_manual(
    'Dimension',
    breaks = c('H','E','V'),
    labels = c('Hazard','Exposure','Vulnerability'),
    values = colors.hev) + 
  ggtitle('Feature Importance Rank:\nStatewide', subtitle = '') + 
  theme_void() +
  theme(
    text = element_text(family = 'Segoe UI', size = 9),
    axis.text.x = element_text(face = 'bold'),
    plot.title = element_text(hjust = 0.5),
    panel.grid.major.x = element_line(color = 'grey90', size = 0.25),
    legend.position = 'bottom')

plot.sac <- shap.plot %>%
  filter(spat == 'Sacramento') %>% 
  select(fullname, temp, rank, dim) %>% 
  pivot_wider(names_from = temp, values_from = rank) %>% 
  filter(complete.cases(.)) %>% 
  pivot_longer(cols = unique(shap.plot$temp), names_to = 'temp', values_to = 'rank') %>% 
  group_by(temp) %>% arrange(rank) %>% 
  mutate(rankpt = (1:length(dim))/length(dim)) %>% ungroup %>%
  mutate(temp = factor(temp, levels = c('All Years', '2009--')))
g2 <- ggplot(plot.sac) +
  geom_line(aes(x = temp, y = rankpt, group = fullname, color = dim), size = 1) +
  geom_text(
    data = plot.sac %>% filter(temp == 'All Years'),
    aes(x = temp, y = rankpt, label = fullname),
    hjust = 1, nudge_x = -0.1, family = 'Segoe UI', size = 6.5/.pt) + 
  scale_y_reverse() +
  scale_x_discrete(expand = expansion(c(3,0.25)), position = 'top') +
  scale_color_manual(
    'Dimension',
    breaks = c('H','E','V'),
    labels = c('Hazard','Exposure','Vulnerability'),
    values = colors.hev) + 
  ggtitle('Feature Importance Rank:\nSacramento', subtitle = '') + 
  theme_void() +
  theme(
    text = element_text(family = 'Segoe UI', size = 9),
    axis.text.x = element_text(face = 'bold'),
    plot.title = element_text(hjust = 0.5),
    panel.grid.major.x = element_line(color = 'grey90', size = 0.25),
    legend.position = 'bottom')

g1 + g2 + guide_area() + 
  plot_layout(design = 'ab\ncc', heights = c(10,1), guides = 'collect') + 
  plot_annotation(tag_levels = 'a', tag_prefix = '(', tag_suffix = ')') &
  theme(
    plot.tag = element_text(size = 10, face = 'bold'),
    plot.tag.position = c(0.1,0.95))
ggsave('_figures/fig3_temporalimp.png', width = 6, height = 5)

```

## FIG 4: spatial comparison

```{r width = 6, height = 6}
plot.1981 <- shap.plot %>%
  filter(temp == 'All Years') %>% 
  select(fullname, spat, rank, dim) %>% 
  pivot_wider(names_from = spat, values_from = rank) %>% 
  filter(complete.cases(.)) %>% 
  pivot_longer(cols = unique(shap.plot$spat), names_to = 'spat', values_to = 'rank') %>% 
  group_by(spat) %>% arrange(rank) %>% 
  mutate(rankpt = (1:length(dim))/length(dim)) %>% ungroup %>%
  mutate(spat = factor(spat, levels = c('Statewide', 'Sacramento')))
g1 <- ggplot(plot.1981) +
  geom_line(aes(x = spat, y = rankpt, group = fullname, color = dim), size = 1) +
  geom_text(
    data = plot.1981 %>% filter(spat == 'Statewide'),
    aes(x = spat, y = rankpt, label = fullname),
    hjust = 1, nudge_x = -0.1, family = 'Segoe UI', size = 6.5/.pt) + 
  scale_y_reverse() +
  scale_x_discrete(expand = expansion(c(3,0.1)), position = 'top') +
  scale_color_manual(
    'Dimension',
    breaks = c('H','E','V'),
    labels = c('Hazard','Exposure','Vulnerability'),
    values = colors.hev) + 
  ggtitle('Feature Importance Rank:\nAll Years', subtitle = '') + 
  theme_void() +
  theme(
    text = element_text(family = 'Segoe UI', size = 9),
    axis.text.x = element_text(face = 'bold'),
    plot.title = element_text(hjust = 0.5),
    panel.grid.major.x = element_line(color = 'grey90', size = 0.25),
    legend.position = 'bottom')

plot.2009 <- shap.plot %>%
  filter(temp == '2009--') %>% 
  select(fullname, spat, rank, dim) %>% 
  pivot_wider(names_from = spat, values_from = rank) %>% 
  filter(complete.cases(.)) %>% 
  pivot_longer(cols = unique(shap.plot$spat), names_to = 'spat', values_to = 'rank') %>% 
  group_by(spat) %>% arrange(rank) %>% 
  mutate(rankpt = (1:length(dim))/length(dim)) %>% ungroup %>%
  mutate(spat = factor(spat, levels = c('Statewide', 'Sacramento')))
g2 <- ggplot(plot.2009) +
  geom_line(aes(x = spat, y = rankpt, group = fullname, color = dim), size = 1) +
  geom_text(
    data = plot.2009 %>% filter(spat == 'Statewide'),
    aes(x = spat, y = rankpt, label = fullname),
    hjust = 1, nudge_x = -0.1, family = 'Segoe UI', size = 6.5/.pt) + 
  scale_y_reverse() +
  scale_x_discrete(expand = expansion(c(3,0.25)), position = 'top') +
  scale_color_manual(
    'Dimension',
    breaks = c('H','E','V'),
    labels = c('Hazard','Exposure','Vulnerability'),
    values = colors.hev) + 
  ggtitle('Feature Importance Rank:\n2009--', subtitle = '') + 
  theme_void() +
  theme(
    text = element_text(family = 'Segoe UI', size = 9),
    axis.text.x = element_text(face = 'bold'),
    plot.title = element_text(hjust = 0.5),
    panel.grid.major.x = element_line(color = 'grey90', size = 0.25),
    legend.position = 'bottom')

g1 + g2 + guide_area() + 
  plot_layout(design = 'ab\ncc', heights = c(10,1), guides = 'collect') +
  plot_annotation(tag_levels = 'a', tag_prefix = '(', tag_suffix = ')') &
  theme(
    plot.tag = element_text(size = 10, face = 'bold'),
    plot.tag.position = c(0.1,0.95))
ggsave('_figures/fig4_spatialimp.png', width = 6, height = 5)

```

# Variable Impact

## FIG 5: SHAP/ALE 

```{r}
## set plot parameters
ptsize <- 0.5
linesize <- 0.75
ptcol <- 'grey50'
  
ctycol <- 'black'
  
rangehaz <- c(-0.3, 0.25)
rangeexp <- c(-0.125, 0.1)
rangevuln <- c(-0.15, 0.1)

```

```{r}
gbase.sac <- ggplot() + 
    geom_hline(yintercept = 0, color = 'grey50', size = 0.25) + 
  scale_y_continuous(
    'SHAP Feature Contribution',
    labels = percent,
    sec.axis = sec_axis(~., name = 'Accumulated Local Effects', labels = percent)) +
  theme(
    text = element_text(size = 9),
    panel.grid.major.y = element_line(size = 0.25),
    axis.line.y.right = element_line(color = saccol),
    axis.ticks.y.right = element_line(color = saccol),
    axis.title.y.left = element_blank(),
    axis.title.y.right = element_blank(),
    axis.text.y.left = element_blank(),
    axis.text.y.right = element_blank())

gbase.cty <- gbase.sac + 
  theme(
    axis.line.y.right = element_line(color = ctycol),
    axis.ticks.y.right = element_line(color = ctycol))

```

```{r}
xname <- 'logprecip_total'
g1h.cty <- gbase.cty + 
  geom_point(
    data = transfm(df.pca.cty, xname) %>% slice(samp.cty) %>% 
      mutate(y = shap.cty %>% data.frame %>% slice(samp.cty) %>% pull(xname)),
    aes(x = x, y = y), size = ptsize, color = ptcol, alpha = 0.25) + 
  geom_line(
    data = ale.cty %>% 
      filter(.feature == xname) %>% 
      mutate(.borders = toNumber(.borders)) %>% 
      filter(
        .borders > quantile(df.pca.cty[,xname],0.025) &
          .borders < quantile(df.pca.cty[,xname],0.975)) %>% 
      mutate(x = ifelse(grepl('log',.feature), 10^.borders-1, .borders)),
    aes(x = x, y = .value), size = linesize) +
  labs(
    title = 'Top 3 Hazard',
    x = dimension$fullname[dimension$var==xname] %>% str_wrap(width = 20)) +
  scale_x_continuous(expand = expansion(mult = c(0.02,0.05))) + 
  coord_cartesian(ylim = rangehaz) +
  theme(
    plot.title = element_text(face = 'bold', color = '#dda077'),
    # axis.line.y.right = element_line(color = colors.hev[1]),
    # axis.ticks.y.right = element_line(color = colors.hev[1]),
    # axis.title.y.left = element_text(),
    axis.text.y.left = element_text())

xname <- 'maxivt'
g2h.cty <- gbase.cty + 
  geom_point(
    data = transfm(df.pca.cty, xname) %>% slice(samp.cty) %>% 
      mutate(y = shap.cty %>% data.frame %>% slice(samp.cty) %>% pull(xname)),
    aes(x = x, y = y), size = ptsize, color = ptcol, alpha = 0.25) + 
  geom_line(
    data = ale.cty %>% 
      filter(.feature == xname) %>% 
      mutate(.borders = toNumber(.borders)) %>% 
      filter(
        .borders > quantile(df.pca.cty[,xname],0.025) &
          .borders < quantile(df.pca.cty[,xname],0.975)) %>% 
      mutate(x = ifelse(grepl('log',.feature), 10^.borders-1, .borders)),
    aes(x = x, y = .value), size = linesize) +
  coord_cartesian(xlim = c(250,NA), ylim = rangehaz) + 
  labs(
    x = dimension$fullname[dimension$var==xname] %>% str_wrap(width = 20)) +
  scale_x_continuous(breaks = 250*(0:10), expand = expansion(mult = c(0,0.05)))


xname <- 'logprecip_lag07'
g3h.cty <- gbase.cty + 
  geom_point(
    data = transfm(df.pca.cty, xname) %>% slice(samp.cty) %>% 
      mutate(y = shap.cty %>% data.frame %>% slice(samp.cty) %>% pull(xname)),
    aes(x = x, y = y), size = ptsize, color = ptcol, alpha = 0.25) + 
  geom_line(
    data = ale.cty %>% 
      filter(.feature == xname) %>% 
      mutate(.borders = toNumber(.borders)) %>% 
      filter(
        .borders > quantile(df.pca.cty[,xname],0.025) &
          .borders < quantile(df.pca.cty[,xname],0.975)) %>% 
      mutate(x = ifelse(grepl('log',.feature), 10^.borders-1, .borders)),
    aes(x = x, y = .value), size = linesize) +
  labs(
    x = dimension$fullname[dimension$var==xname] %>% str_wrap(width = 20)) +
  scale_x_continuous(expand = expansion(mult = c(0.02,0.05))) + 
  coord_cartesian(xlim = c(0,200), ylim = rangehaz) +
  theme(
    # axis.line.y.right = element_line(color = colors.hev[1]),
    # axis.ticks.y.right = element_line(color = colors.hev[1]),
    # axis.title.y.right = element_text(color = ctycol),
    axis.text.y.right = element_text())

```

```{r}
xname <- 'loghu'
g1e.cty <- gbase.cty + 
  geom_point(
    data = transfm(df.pca.cty, xname) %>% slice(samp.cty) %>% 
      mutate(y = shap.cty %>% data.frame %>% slice(samp.cty) %>% pull(xname)),
    aes(x = x, y = y), size = ptsize, color = ptcol, alpha = 0.25) + 
  geom_line(
    data = ale.cty %>% 
      filter(.feature == xname) %>% 
      mutate(.borders = toNumber(.borders)) %>% 
      filter(
        .borders > quantile(df.pca.cty[,xname],0.025) &
          .borders < quantile(df.pca.cty[,xname],0.975)) %>% 
      mutate(x = ifelse(grepl('log',.feature), 10^.borders-1, .borders)),
    aes(x = x, y = .value), size = linesize) +
  labs(
    title = 'Top 3 Exposure',
    x = dimension$fullname[dimension$var==xname] %>% str_wrap(width = 20)) +
  scale_x_log10() + annotation_logticks(sides = 'b', size = 0.25, color = 'grey25') + 
  coord_cartesian(ylim = rangeexp) + 
  theme(
    plot.title = element_text(face = 'bold', color = '#71938f'),
    # axis.line.y.right = element_line(color = colors.hev[2]),
    # axis.ticks.y.right = element_line(color = colors.hev[2]),
    axis.title.y.left = element_text(),
    axis.text.y.left = element_text())

xname <- 'pop_pct_floodplain'
g2e.cty <- gbase.cty + 
  geom_point(
    data = transfm(df.pca.cty, xname) %>% slice(samp.cty) %>% 
      mutate(y = shap.cty %>% data.frame %>% slice(samp.cty) %>% pull(xname)),
    aes(x = x, y = y), size = ptsize, color = ptcol, alpha = 0.25) + 
  geom_line(
    data = ale.cty %>% 
      filter(.feature == xname) %>% 
      mutate(.borders = toNumber(.borders)) %>% 
      filter(
        .borders > quantile(df.pca.cty[,xname],0.025) &
          .borders < quantile(df.pca.cty[,xname],0.975)) %>% 
      mutate(x = ifelse(grepl('log',.feature), 10^.borders-1, .borders)),
    aes(x = x, y = .value), size = linesize) +
  labs(
    x = dimension$fullname[dimension$var==xname] %>% str_wrap(width = 20)) +
  scale_x_continuous(labels = percent, expand = expansion(mult = c(0.02,0.05))) + 
  coord_cartesian(xlim = c(0,0.4), ylim = rangeexp)

xname <- 'pct_sfh'
g3e.cty <- gbase.cty + 
  geom_point(
    data = transfm(df.pca.cty, xname) %>% slice(samp.cty) %>% 
      mutate(y = shap.cty %>% data.frame %>% slice(samp.cty) %>% pull(xname)),
    aes(x = x, y = y), size = ptsize, color = ptcol, alpha = 0.25) + 
  geom_line(
    data = ale.cty %>% 
      filter(.feature == xname) %>% 
      mutate(.borders = toNumber(.borders)) %>% 
      filter(
        .borders > quantile(df.pca.cty[,xname],0.025) &
          .borders < quantile(df.pca.cty[,xname],0.975)) %>% 
      mutate(x = ifelse(grepl('log',.feature), 10^.borders-1, .borders)),
    aes(x = x, y = .value), size = linesize) +
  labs(
    x = dimension$fullname[dimension$var==xname] %>% str_wrap(width = 24)) +
  scale_x_continuous(labels = percent, expand = expansion(mult = 0.05)) + 
  coord_cartesian(xlim = c(0.4,NA), ylim = rangeexp) + 
  theme(
    # axis.line.y.right = element_line(color = colors.hev[2]),
    # axis.ticks.y.right = element_line(color = colors.hev[2]),
    axis.title.y.right = element_text(),
    axis.text.y.right = element_text())

```

```{r}
xname <- 'CRS'
g1v.cty <- gbase.cty + 
  geom_point(
    data = transfm(df.pca.cty, xname) %>% slice(samp.cty) %>% 
      mutate(y = shap.cty %>% data.frame %>% slice(samp.cty) %>% pull(xname)),
    aes(x = jitter(x), y = y), size = ptsize, color = ptcol, alpha = 0.25) + 
  geom_line(
    data = ale.cty %>% 
      filter(.feature == xname) %>% 
      mutate(.borders = toNumber(.borders)) %>% 
      filter(.borders > 2) %>% 
      mutate(x = ifelse(grepl('log',.feature), 10^.borders-1, .borders)),
    aes(x = x, y = .value), size = linesize) +
  labs(
    title = 'Top 3 Vulnerability',
    x = dimension$fullname[dimension$var==xname] %>% str_wrap(width = 20)) +
  coord_cartesian(ylim = rangevuln) +
  scale_x_continuous(breaks = 2:10) + 
  theme(
    plot.title = element_text(face = 'bold', color = colors.hev[3]),
    # axis.line.y.right = element_line(color = colors.hev[3]),
    # axis.ticks.y.right = element_line(color = colors.hev[3]),
    # axis.title.y.left = element_text(),
    axis.text.y.left = element_text())

xname <- 'pct_dac'
g2v.cty <- gbase.cty + 
  geom_point(
    data = transfm(df.pca.cty, xname) %>% slice(samp.cty) %>% 
      mutate(y = shap.cty %>% data.frame %>% slice(samp.cty) %>% pull(xname)),
    aes(x = x, y = y), size = ptsize, color = ptcol, alpha = 0.25) + 
  geom_line(
    data = ale.cty %>% 
      filter(.feature == xname) %>% 
      mutate(.borders = toNumber(.borders)) %>% 
      filter(
        .borders > quantile(df.pca.cty[,xname],0.025) &
          .borders < quantile(df.pca.cty[,xname],0.975)) %>% 
      mutate(x = ifelse(grepl('log',.feature), 10^.borders-1, .borders)),
    aes(x = x, y = .value), size = linesize) +
  labs(
    x = dimension$fullname[dimension$var==xname] %>% str_wrap(width = 20)) +
  scale_x_continuous(labels = percent, expand = expansion(0.02)) + 
  coord_cartesian(ylim = rangevuln)

xname <- 'hhincome22'
g3v.cty <- gbase.cty + 
  geom_point(
    data = transfm(df.pca.cty, xname) %>% slice(samp.cty) %>% 
      mutate(y = shap.cty %>% data.frame %>% slice(samp.cty) %>% pull(xname)),
    aes(x = x, y = y), size = ptsize, color = ptcol, alpha = 0.25) + 
  geom_line(
    data = ale.cty %>% 
      filter(.feature == xname) %>% 
      mutate(.borders = toNumber(.borders)) %>% 
      filter(
        .borders > quantile(df.pca.cty[,xname],0.025) &
          .borders < quantile(df.pca.cty[,xname],0.975)) %>% 
      mutate(x = ifelse(grepl('log',.feature), 10^.borders-1, .borders)),
    aes(x = x, y = .value), size = linesize) +
  labs(
    x = dimension$fullname[dimension$var==xname] %>% str_wrap(width = 20)) +
  scale_x_continuous(labels = comma_format(scale = 1e-3, prefix = '$', suffix = 'K')) + 
  coord_cartesian(ylim = rangevuln) +
  theme(
    # axis.line.y.right = element_line(color = colors.hev[3]),
    # axis.ticks.y.right = element_line(color = colors.hev[3]),
    # axis.title.y.right = element_text(color = ctycol),
    axis.text.y.right = element_text())

```

```{r fig.width=6, fig.height=6}
g1h.cty + g2h.cty + g3h.cty +
  g1e.cty + g2e.cty + g3e.cty + 
  g1v.cty + g2v.cty + g3v.cty + 
  plot_layout(nrow = 3) +
  plot_annotation(tag_levels = 'a', tag_prefix = '(', tag_suffix = ')') &
  theme(
    legend.position = 'none',
    plot.tag = element_text(face = 'bold'),
    plot.tag.position = c(0.12,0.975)) #1.01 without the title
ggsave('_figures/fig5_impact.png', width = 6, height = 6)

```

