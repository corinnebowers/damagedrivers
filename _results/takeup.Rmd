---
title: "Untitled"
output: html_document
date: "2023-04-30"
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = 'D:/6-MLDD/')
# knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
knitr::opts_chunk$set(results = 'hold', fig.show = 'hold', fig.align = 'center')
# rm(list=ls())

```

# setup

```{r}
source('_data/setup.R')

require(DMwR)
require(themis)

```

```{r}
load('_data/_checkpoints/county_catalog_0510.Rdata')
load('_data/_checkpoints/county_takeup_0424.Rdata')
load('_results/county_rfmodel_0.Rdata')

load('_data/_checkpoints/bg_0417.Rdata')

polys <- california %>% 
  arrange(NAME) %>%  
  transmute(id = 1:nrow(.), name = NAME, geometry) 

```


# start

# insurance takeup rate

```{r}
g1 <- takeup %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = takeup)) + 
  ggtitle(waiver(), subtitle = 'insurance takeup rate') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))

```

## how many houses are in the NFHL?

```{r}
## load policies
load('_data/policies_save.Rdata')

## clean up & aggregate policies by county
policies.poly <- policies %>%
  transmute(
    floodZone,
    county = str_sub(countyCode, start = 3, end = 5),
    tract = str_sub(censusTract, start = 6),
    policy_start = ymd_hms(policyEffectiveDate),
    policy_end = ymd_hms(policyTerminationDate)) %>%
  filter(complete.cases(.)) %>%
  filter(ymd('2019-10-01') %within% interval(policy_start, policy_end)) %>%
  left_join(california %>% st_drop_geometry %>% select(COUNTYFP,NAME), by = c('county' = 'COUNTYFP')) %>%
  left_join(polys %>% st_drop_geometry %>% select(id,name), by = c('NAME' = 'name')) %>%
  filter(!is.na(id))
policies.poly <- policies.poly %>% 
  mutate(NFHL = grepl('A',floodZone) | grepl('V',floodZone))

```

```{r}
## what is the average insurance penetration within vs. outside of the floodplain? 

hu_bytract <-   
  bg %>% st_drop_geometry %>% 
  transmute(county = COUNTYFP, tract = TRACTCE, pctarea = partarea/area, hu) %>% 
  mutate(hu_in = hu*pctarea, hu_out = hu*(1-pctarea)) %>% 
  group_by(county, tract) %>% 
  summarize(
    hu = Sum(hu), hu_in = round(sum(hu_in)), hu_out = round(sum(hu_out)), 
    .groups = 'drop')

policies_bytract <- policies.poly %>%
  count(county, tract, NFHL) %>% 
  mutate(temp = case_when(NFHL ~ 'policies_in', TRUE ~ 'policies_out')) %>% 
  select(-NFHL) %>% 
  pivot_wider(id_cols = c(county,tract), names_from = temp, values_from = n) %>% 
  mutate(across(starts_with('policies'), ~setNA(.,0)))

```

```{r}
takeup_in <- Sum(policies_bytract$policies_in) / Sum(hu_bytract$hu_in)
takeup_out <- Sum(policies_bytract$policies_out) / Sum(hu_bytract$hu_out)

bg %>% st_drop_geometry %>% 
  transmute(county = COUNTYFP, tract = TRACTCE, pctarea = partarea/area, hu) %>% 
  mutate(
    hu_in = hu*pctarea, hu_out = hu*(1-pctarea),
    exp_in = takeup_in*hu_in, exp_out = takeup_out*hu_out) %>% 
  summarize(exp_in = sum(exp_in), exp_out = sum(exp_out)) %>% sum
Sum(policies_bytract$policies_in) + Sum(policies_bytract$policies_out)

```

```{r}
takeup_bytract <- bg %>% st_drop_geometry %>%
  transmute(county = COUNTYFP, tract = TRACTCE, pctarea = partarea/area, hu) %>% 
  mutate(
    hu_in = hu*pctarea, hu_out = hu*(1-pctarea),
    exp_in = takeup_in*hu_in, exp_out = takeup_out*hu_out) %>% 
  group_by(county, tract) %>% 
  summarize(
    hu = Sum(hu), hu_in = round(sum(hu_in)), hu_out = hu-hu_in,
    exp_in = round(sum(exp_in)), exp_out = round(sum(exp_out)), .groups = 'drop') %>% 
  full_join(policies_bytract, by = c('county', 'tract')) %>% 
  mutate(across(c(ends_with('in'), ends_with('out')), ~setNA(.,0))) 
takeup_bytract %>% summarize(across(c(ends_with('in'), ends_with('out')), Sum))

```

```{r}
g1 <- ggplot(takeup_bytract) + 
  geom_point(aes(x = policies_in, y = exp_in), alpha = 0.25) + 
  scale_x_origin() + scale_y_origin() +
  geom_parity() + 
  ggtitle(waiver(), subtitle = 'Within NFHL') + 
  labs(x = 'Observed', y = 'Expected') + 
  theme(panel.grid.major = element_line(size = 0.25))
g2 <- ggplot(takeup_bytract) + 
  geom_point(aes(x = policies_out, y = exp_out), alpha = 0.25) + 
  scale_x_origin() + scale_y_origin() +
  geom_parity() + 
  ggtitle(waiver(), subtitle = 'Outside NFHL') + 
  labs(x = 'Observed', y = 'Expected') + 
  theme(panel.grid.major = element_line(size = 0.25))
g1 + g2 + plot_annotation(title = 'Tract-Level Takeup Rates')
ggsave('_figures/takeup_tract.png', width = 6, height = 3.5)

g1 <- ggplot(takeup_bytract %>% filter(county == '067')) + 
  geom_point(aes(x = policies_in, y = jitter(exp_in)), alpha = 0.25) + 
  scale_x_origin() + scale_y_origin() +
  geom_parity() + 
  ggtitle(waiver(), subtitle = 'Within NFHL') + 
  labs(x = 'Observed', y = 'Expected') + 
  theme(panel.grid.major = element_line(size = 0.25))
g2 <- ggplot(takeup_bytract %>% filter(county == '067')) + 
  geom_point(aes(x = policies_out, y = jitter(exp_out)), alpha = 0.25) + 
  scale_x_origin() + scale_y_origin() +
  geom_parity() + 
  ggtitle(waiver(), subtitle = 'Outside NFHL') + 
  labs(x = 'Observed', y = 'Expected') + 
  theme(panel.grid.major = element_line(size = 0.25))
g1 + g2 + plot_annotation(
  title = 'Tract-Level Takeup Rates (Sacramento Only)',
  subtitle = 'Statewide Expected Takeup')
ggsave('_figures/takeup_sac1.png', width = 6, height = 3.5)

```

```{r}
## recalculate Sac-only with Sac-specific takeup rates
takeup_sac <- takeup_bytract %>% 
  filter(county == '067') %>% 
  summarize(across(c(ends_with('in'), ends_with('out')), Sum)) %>% 
  transmute(takeup_in = policies_in/hu_in, takeup_out = policies_out/hu_out) %>% 
  cbind(takeup_bytract %>% filter(county == '067'), .) %>% 
  mutate(exp_in = hu_in*takeup_in, exp_out = hu_out*takeup_out) %>% 
  select(-starts_with('hu'), -starts_with('takeup'))
takeup_sac %>% summarize(across(c(ends_with('in'), ends_with('out')), Sum))

g1 <- ggplot(takeup_sac) + 
  geom_point(aes(x = policies_in, y = jitter(exp_in)), alpha = 0.25) + 
  scale_x_origin() + scale_y_origin() +
  geom_parity() + 
  ggtitle(waiver(), subtitle = 'Within NFHL') + 
  labs(x = 'Observed', y = 'Expected') + 
  theme(panel.grid.major = element_line(size = 0.25))
g2 <- ggplot(takeup_sac) + 
  geom_point(aes(x = policies_out, y = jitter(exp_out)), alpha = 0.25) + 
  scale_x_origin() + scale_y_origin() +
  geom_parity() + 
  ggtitle(waiver(), subtitle = 'Outside NFHL') + 
  labs(x = 'Observed', y = 'Expected') + 
  theme(panel.grid.major = element_line(size = 0.25))
g1 + g2 + 
  plot_annotation(
    title = 'Tract-Level Takeup Rates (Sacramento Only)', 
    subtitle = 'Sacramento-Specific Expected Takeup')
ggsave('_figures/takeup_sac2.png', width = 6, height = 3.5)

```

```{r}
takeup_bycounty <- takeup_bytract %>%
  group_by(county) %>% 
  summarize(across(c(ends_with('in'), ends_with('out')), Sum)) %>% 
  left_join(
    california %>% st_drop_geometry %>% select(NAME,COUNTYFP), 
    by = c('county' = 'COUNTYFP')) %>% 
  mutate(policies = policies_in+policies_out, exp = exp_in+exp_out)

g1 <- ggplot(takeup_bycounty) +
  geom_point(aes(x = exp_in, y = policies_in), size = 1) + 
  geom_line(
    data = data.frame(x = 0:max(takeup_bycounty$exp_in)) %>% 
      mutate(y = predict(
        lm(policies_in ~ exp_in, data = takeup_bycounty), 
        data.frame(exp_in = x))),
    aes(x = x, y = y), color = baker[2], size = 0.5) + 
  geom_text(
    data = takeup_bycounty %>% filter(abs(policies_in-exp_in) > 5e3),
    aes(x = exp_in, y = policies_in, label = NAME),
    family = 'Segoe UI', size = 8/.pt, color = 'grey40', 
    nudge_x = -750, nudge_y = -1000) + 
  geom_text(
    data = data.frame(
      x = 5000, y = 8500, 
      R2 = lm(policies_in ~ exp_in, data = takeup_bycounty) %>% 
        summary %>% .$r.squared %>% round(3)),
    aes(x = x, y = y, label = paste('~R^2 ==', R2)), parse = TRUE,
    family = 'Segoe UI', size = 8/.pt, color = baker[2], 
    nudge_x = 0, nudge_y = 0) + 
  scale_x_origin(labels = comma) + scale_y_origin(labels = comma) +
  geom_parity() + 
  ggtitle(waiver(), subtitle = 'Within NFHL') + 
  labs(x = 'Expected', y = 'Observed') + 
  theme(panel.grid.major = element_line(size = 0.25))
g2 <- ggplot(takeup_bycounty) + 
  geom_point(aes(x = exp_out, y = policies_out), size = 1) + 
  geom_line(
    data = data.frame(x = 0:max(takeup_bycounty$exp_out)) %>% 
      mutate(y = predict(
        lm(policies_out ~ exp_out, data = takeup_bycounty), 
        data.frame(exp_out = x))),
    aes(x = x, y = y), color = baker[2], size = 0.5) + 
  geom_text(
    data = takeup_bycounty %>% filter(abs(policies_out-exp_out) > 5e3),
    aes(x = exp_out, y = policies_out, label = NAME),
    family = 'Segoe UI', size = 8/.pt, color = 'grey40', 
    nudge_x = 2500*c(-1,0.5), nudge_y = -750) + 
  geom_text(
    data = data.frame(
      x = 18000, y = 7500, 
      R2 = lm(policies_out ~ exp_out, data = takeup_bycounty) %>% 
        summary %>% .$r.squared %>% round(3)),
    aes(x = x, y = y, label = paste('~R^2 ==', R2)), parse = TRUE,
    family = 'Segoe UI', size = 8/.pt, color = baker[2], 
    nudge_x = 0, nudge_y = 0) + 
  scale_x_origin(labels = comma) + scale_y_origin(labels = comma) +
  geom_parity() + 
  ggtitle(waiver(), subtitle = 'Outside NFHL') + 
  labs(x = 'Expected', y = 'Observed') + 
  theme(panel.grid.major = element_line(size = 0.25))
g1 + g2 + 
  plot_annotation(
    # title = 'County-Level Takeup Rates',
    tag_levels = 'a', tag_prefix = '(', tag_suffix = ')') &
  theme(
    plot.tag = element_text(size = 10, face = 'bold'),
    plot.tag.position = c(0.12,0.985))
ggsave('_figures/takeup_county.png', width = 6, height = 3.5)

```


```{r}
## overall
takeup_bycounty <- takeup_bycounty %>% 
  mutate(hu = hu_in+hu_out) %>%
  mutate(takeup_obs = policies/hu, takeup_exp = exp/hu)

g1 <- ggplot(takeup_bycounty) + 
  geom_ribbon(
    data = data.frame(x = (0:(max(takeup_bycounty$takeup_exp+0.01)*1e4))/1e4) %>% 
      mutate(lower = positive(x-0.01), upper = x+0.01),
    aes(x = x, ymin = lower, ymax = upper), fill = 'grey70', alpha = 0.25) + 
  geom_point(aes(x = takeup_exp, y = takeup_obs), size = 1) + 
  geom_text(
    data = takeup_bycounty %>% filter(abs(takeup_exp-takeup_obs) > 0.03),
    aes(x = takeup_exp, y = takeup_obs, label = NAME),
    family = 'Segoe UI', size = 7/.pt, color = 'grey40', 
    nudge_x = 0, nudge_y = -0.005) + 
  scale_x_origin(labels = percent) + scale_y_origin(labels = percent) +
  geom_parity() + coord_cartesian(xlim = range(takeup_bycounty$takeup_exp)) + 
  labs(x = 'Expected Takeup Rate', y = 'Observed Takeup Rate') + 
  theme(panel.grid.major = element_line(size = 0.25))
g2 <- ggplot(takeup_bycounty) + 
  geom_ribbon(
    data = data.frame(x = 10*(1:(max(takeup_bycounty$exp)/10+1e3))) %>% 
      mutate(half = x/2, double = x*2),
    aes(x = x, ymin = half, ymax = double), fill = 'grey70', alpha = 0.25) + 
  geom_text(
    data = takeup_bycounty %>% filter(policies/exp > 5),
    aes(x = exp, y = policies*1.45, label = NAME),
    family = 'Segoe UI', size = 7/.pt, color = 'grey40', 
    nudge_x = 0, nudge_y = 0) + 
  geom_text(
    data = takeup_bycounty %>% filter(exp/policies > 5),
    aes(x = exp, y = (policies+c(0,0,1.5,0,0))/1.35, label = NAME),
    family = 'Segoe UI', size = 7/.pt, color = 'grey40', 
    nudge_x = c(0.15,0,0,0,0), nudge_y = c(0,0,0,0,0)) + 
  geom_point(aes(x = exp, y = policies), size = 1) + 
  scale_x_log10(labels = comma) + scale_y_log10(labels = comma) + 
  annotation_logticks(sides = 'bl', size = 0.25, color = 'grey25') + 
  geom_parity() + coord_fixed(clip = 'off', xlim = range(takeup_bycounty$exp)) + 
  labs(x = 'Expected Number of Policies', y = 'Observed Number of Policies') + 
  theme(panel.grid.major = element_line(size = 0.25))
g2 + g1 + 
  plot_layout(widths = c(1,1)) + 
  plot_annotation(
    # title = 'County-Level Takeup Rates',
    tag_levels = 'a', tag_prefix = '(', tag_suffix = ')') &
  theme(
    plot.tag = element_text(size = 10, face = 'bold'),
    plot.tag.position = c(0,1))
ggsave('_figures/takeup_county_all.png', width = 6, height = 3.5)

```

```{r}
takeup_bycounty %>% 
  filter(takeup_exp < takeup_obs+0.01 & takeup_exp > takeup_obs-0.01) %>% nrow

takeup_bycounty %>% 
  filter(exp < 2*policies & exp > policies/2) %>% nrow

```

```{r}
## number of policies
lm(policies ~ exp, data = takeup_bycounty) %>%
  summary %>% .$r.squared
## number of policies (log scale)
lm(log10(policies+1) ~ log10(exp+1), data = takeup_bycounty) %>%
  summary %>% .$r.squared
## takeup rates
lm(takeup_obs ~ takeup_exp, data = takeup_bycounty) %>%
  summary %>% .$r.squared

```

```{r}
## overall observed vs. expected takeup rates

g2 <- ggplot(takeup_bycounty) + 
  geom_ribbon(
    data = data.frame(x = 10*(1:(max(takeup_bycounty$exp)/10+1e3))) %>% 
      mutate(half = x/2, double = x*2),
    aes(x = x, ymin = half, ymax = double), fill = 'grey70', alpha = 0.25) + 
  geom_point(aes(x = exp, y = policies), size = 1) + 
  scale_x_log10(labels = comma) + scale_y_log10(labels = comma) + 
  annotation_logticks(sides = 'bl', size = 0.25, color = 'grey25') + 
  geom_parity() + coord_fixed(clip = 'off', xlim = range(takeup_bycounty$exp)) + 
  labs(x = 'Expected', y = 'Observed') + 
  theme(panel.grid.major = element_line(size = 0.25))
g1 + g2 + 
  plot_annotation(
    # title = 'County-Level Takeup Rates',
    tag_levels = 'a', tag_prefix = '(', tag_suffix = ')') &
  theme(
    plot.tag = element_text(size = 10, face = 'bold'))
ggsave('_figures/takeup_county_all.png', width = 6, height = 3.5)

```

```{r}
percent(takeup_in, accuracy = 0.1)
percent(takeup_out, accuracy = 0.01)

takeup_bycounty %>% 
  mutate(takeup_in = policies_in/hu_in, takeup_out = policies_out/hu_out) %>% 
  View

```


```{r}
takeup.exp <-
  bg %>% st_drop_geometry %>% 
  transmute(county = COUNTYFP, tract = TRACTCE, pctarea = partarea/area, hu) %>% 
  mutate(policies.exp = 0.4*pctarea*hu + 0.01*(1-pctarea)*hu) %>%
  group_by(county) %>% 
  summarize(hu = sum(hu), policies.exp = sum(policies.exp)) %>% 
  ungroup %>% 
  left_join(
    policies.poly %>% count(county, name = 'policies'),
    by = 'county') %>%
  mutate(
    takeup.obs = setNA(policies/hu,0), 
    takeup.exp = setNA(policies.exp/hu,0))

g2 <- ggplot(takeup.exp) + 
  geom_point(aes(x = takeup.obs, y = takeup.exp)) + 
  scale_x_origin('Observed County Takeup Rate', labels = percent, breaks = 0.05*(0:10)) + 
  scale_y_origin('Theoretical County Takeup Rate', labels = percent, breaks = 0.05*(0:10)) + 
  geom_parity() + coord_fixed() + 
  theme(panel.grid.major = element_line(size = 0.25))
g2

```

```{r}
g1 + g2 

```

```{r}
temp <- catalog.df %>% 
  count(id, y = claims_num>0) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  setNames(c('id','no','yes')) %>% 
  mutate(
    total = cbind(yes,no) %>% apply(1,Sum),
    pct_damaging = setNA(yes/total,0)) %>% 
  left_join(polys %>% st_drop_geometry %>% select(id,name), by = 'id') %>% 
  left_join(
    california %>% st_drop_geometry %>% select(COUNTYFP,NAME), 
    by = c('name' = 'NAME')) %>% 
  left_join(takeup.exp, by = c('COUNTYFP' = 'county'))
  
g1 <- ggplot(temp) + 
  geom_point(aes(x = takeup.obs, y = pct_damaging)) +
  scale_x_origin('County Takeup Rate', labels = percent) + 
  scale_y_origin('Percent of Events with Damage', labels = percent) + 
  coord_cartesian(clip = 'off') + 
  theme(panel.grid.major = element_line(size = 0.25))
g2 <- ggplot(temp) + 
  geom_point(aes(x = setNA(policies,0), y = pct_damaging)) +
  scale_x_origin('Number of Policies', labels = comma_format(scale = 1e-3, suffix = 'K')) + 
  scale_y_origin('Percent of Events with Damage', labels = percent) + 
  coord_cartesian(clip = 'off') + 
  theme(panel.grid.major = element_line(size = 0.25))
g1 + g2 + plot_annotation('"damage": number of claims > 0')

g2 <- ggplot(temp %>% filter(name != 'Sacramento')) + 
  geom_point(aes(x = setNA(policies,0), y = pct_damaging)) +
  scale_x_origin('Number of Policies', labels = comma_format(scale = 1e-3, suffix = 'K')) + 
  scale_y_origin('Percent of Events with Damage', labels = percent) + 
  ggtitle(waiver(), subtitle = 'excluding Sacramento') + 
  coord_cartesian(clip = 'off') + 
  theme(panel.grid.major = element_line(size = 0.25))
g1 + g2 + plot_annotation('"damage": number of claims > 0')

# temp %>% arrange(desc(policies))
# temp %>% arrange(desc(takeup.obs))
  
```

## what would it look like to scale claims/policies?

```{r}
policies.poly %>% 
  count(id, name = 'policies') %>% 
  pull(policies) %>% summary

catalog.df %>% 
  left_join(policies.poly %>% count(id, name = 'policies'), by = 'id') %>% 
  mutate(policies = setNA(policies,0)) %>% 
  count(y = claims_num>(policies/1307)) %>% mutate(pct = n/sum(n))
  
temp2 <- catalog.df %>% 
  left_join(policies.poly %>% count(id, name = 'policies'), by = 'id') %>% 
  mutate(policies = setNA(policies,0)) %>% 
  count(id, y = claims_num>(policies/1307)) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  setNames(c('id','no','yes')) %>% 
  mutate(
    total = cbind(yes,no) %>% apply(1,Sum),
    pct_damaging = setNA(yes/total,0)) %>% 
  left_join(polys %>% st_drop_geometry %>% select(id,name), by = 'id') %>% 
  left_join(
    california %>% st_drop_geometry %>% select(COUNTYFP,NAME), 
    by = c('name' = 'NAME')) %>% 
  left_join(takeup.exp, by = c('COUNTYFP' = 'county'))

g1 <- ggplot(temp2) + 
  geom_point(aes(x = takeup.obs, y = pct_damaging)) +
  scale_x_origin('County Takeup Rate', labels = percent) + 
  scale_y_origin('Percent of Events with Damage', labels = percent) + 
  coord_cartesian(clip = 'off') + 
  theme(panel.grid.major = element_line(size = 0.25))
g2 <- ggplot(temp2 %>% filter(name != 'Sacramento')) + 
  geom_vline(xintercept = 1307*1:4, color = 'grey70', linetype = 'dashed') +
  geom_point(aes(x = setNA(policies,0), y = pct_damaging)) +
  scale_x_origin('Number of Policies', labels = comma_format(scale = 1e-3, suffix = 'K')) + 
  scale_y_origin('Percent of Events with Damage', labels = percent) + 
  coord_cartesian(clip = 'off') + 
  ggtitle(waiver(), subtitle = 'excluding Sacramento') + 
  theme(panel.grid.major = element_line(size = 0.25))
g1 + g2 + plot_annotation(title = '"damage": number of claims > (# of policies)/(median policies)')

```


## how many damaging events should I have? 

```{r incldue = FALSE, eval = FALSE}
df.train %>% 
  count(id, y) %>%
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(
    total = cbind(yes,no) %>% apply(1,Sum),
    damage.obs = setNA(yes/total,0)) %>% 
  left_join(polys %>% st_drop_geometry %>% select(id,name), by = 'id') %>%
  left_join(california %>% select(COUNTYFP,NAME), ., by = c('NAME' = 'name')) %>% 
  left_join(takeup.exp, by = c('COUNTYFP' = 'county')) %>% 
  mutate(
    damage.obs = cbind(damage.obs,0.001) %>% apply(1,max),
    takeup.obs = cbind(takeup.obs,0.001) %>% apply(1,max)) %>% 
  mutate(damage.exp = damage.obs*takeup.exp/takeup.obs) %>% 
  mutate(total.exp = damage.exp*total) %>% 
  # st_drop_geometry
  ggplot() + 
  geom_sf(aes(fill = total.exp-setNA(yes,0))) +
  scale_fill_scico(palette = 'vik', midpoint = 0, direction = -1) + 
  ggtitle(waiver(), subtitle = 'how many more events would we expect to be damaging?')
  
df.train %>% 
  count(id, y) %>%
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(
    total = cbind(yes,no) %>% apply(1,Sum),
    damage.obs = setNA(yes/total,0)) %>% 
  left_join(polys %>% st_drop_geometry %>% select(id,name), by = 'id') %>%
  left_join(california %>% select(COUNTYFP,NAME), ., by = c('NAME' = 'name')) %>% 
  left_join(takeup.exp, by = c('COUNTYFP' = 'county')) %>% 
  mutate(
    damage.obs = cbind(damage.obs,0.001) %>% apply(1,max),
    takeup.obs = cbind(takeup.obs,0.001) %>% apply(1,max)) %>% 
  mutate(damage.exp = damage.obs*takeup.exp/takeup.obs) %>% 
  mutate(total.exp = damage.exp*total) %>% 
  # st_drop_geometry
  ggplot() +
  geom_sf(aes(fill = damage.exp-damage.obs)) +
  scale_fill_scico(palette = 'vik', midpoint = 0, direction = -1, labels = percent) + 
  ggtitle(waiver(), subtitle = 'what is the difference between observed and expected % damage?')

## can't calculate the additive difference, because added policies might contribute to the same events

```

## redo unaltered plots with new damage definition

```{r}
df <- catalog.df %>% 
  left_join(policies.poly %>% count(id, name = 'policies'), by = 'id') %>% 
  mutate(policies = setNA(policies,0)) %>% 
  mutate(y = factor(ifelse(claims_num > policies/1307, 'yes', 'no'))) %>% 
  select(-count, -start, -end, -claims_num, -claims_value)

g1 <- catalog.df %>% 
  count(id, y = claims_num > 0) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(pct = setNA(`TRUE`/(`TRUE`+`FALSE`),0)) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = pct)) + 
  ggtitle(waiver(), subtitle = 'P(damage) - old definition') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g2 <- df %>% 
  count(id, y) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(pct = setNA(yes/(yes+no),0)) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = pct)) + 
  ggtitle(waiver(), subtitle = 'P(damage) - new definition') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g1 + g2 + plot_annotation(title = 'unaltered data')

```

# empty counties

```{r}
g1 <- catalog.df %>% 
  count(id) %>% 
  left_join(polys, ., by = 'id') %>% 
  arrange(desc(n)) %>% 
  ggplot() + 
  geom_sf(aes(fill = n)) + 
  ggtitle(waiver(), subtitle = 'number of AR events') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g2 <- df %>% 
  count(id, y) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(pct = setNA(yes/(yes+no),0)) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = pct)) + 
  ggtitle(waiver(), subtitle = 'P(damage) - new definition') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g1 + g2 + plot_annotation(title = 'unaltered data - new damage definition')

```

```{r}
df <- catalog.df %>% 
  left_join(policies.poly %>% count(id, name = 'policies'), by = 'id') %>% 
  mutate(policies = setNA(policies,0)) %>% 
  mutate(y = factor(ifelse(claims_num > policies/1307, 'yes', 'no'))) %>% 
  select(-count, -start, -end, -claims_num, -claims_value)

## impute missing precipitation & sm lags by linear regression
f07 <- lm(logprecip_lag07 ~ logprecip_lag03 + sm_lag03, data = df)
df$logprecip_lag07[is.na(df$logprecip_lag07)] <- 
  predict(f07, df %>% filter(is.na(logprecip_lag07))) %>% 
  cbind(df$logprecip_lag03[is.na(df$logprecip_lag07)]) %>% 
  apply(1,max)
f07 <- lm(sm_lag07 ~ logprecip_lag03 + sm_lag03, data = df)
df$sm_lag07[is.na(df$sm_lag07)] <- predict(f07, df %>% filter(is.na(sm_lag07)))

f14 <- lm(logprecip_lag14 ~ logprecip_lag07 + sm_lag07 + logprecip_lag03 + sm_lag03, data = df)
df$logprecip_lag14[is.na(df$logprecip_lag14)] <- 
  predict(f14, df %>% filter(is.na(logprecip_lag14))) %>% 
  cbind(df$logprecip_lag07[is.na(df$logprecip_lag14)]) %>% 
  apply(1,max)
f14 <- lm(sm_lag14 ~ logprecip_lag07 + sm_lag07 + logprecip_lag03 + sm_lag03, data = df)
df$sm_lag14[is.na(df$sm_lag14)] <- predict(f14, df %>% filter(is.na(sm_lag14)))

f30 <- lm(logprecip_lag30 ~ logprecip_lag14 + sm_lag14 + logprecip_lag07 + sm_lag07 + logprecip_lag03, data = df)
df$logprecip_lag30[is.na(df$logprecip_lag30)] <- 
  predict(f30, df %>% filter(is.na(logprecip_lag30))) %>% 
  cbind(df$logprecip_lag14[is.na(df$logprecip_lag30)]) %>% 
  apply(1,max)
f30 <- lm(sm_lag30 ~ logprecip_lag14 + sm_lag14 + logprecip_lag07 + sm_lag07 + sm_lag03, data = df)
df$sm_lag30[is.na(df$sm_lag30)] <- predict(f30, df %>% filter(is.na(sm_lag30)))

```

```{r}
## create new yeses for counties with <5 yeses

empty <- df %>% 
  count(id,y) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(yes = setNA(yes,0)) %>% arrange(yes) %>% 
  filter(yes < 5) %>% pull(id)
df.temp <- df %>% select(-id)
df$ynew <- df$y

boot = 100
pb <- txtProgressBar(min = 0, max = boot, style = 3)
cl <- makeCluster(cores)
registerDoSNOW(cl)
for (i in empty) {
  temp <- 
    foreach (
      b = 1:boot, 
      .combine = 'cbind',
      .packages = c('randomForest', 'tidyverse'),
      .options.snow = opts) %dopar% {
        f.rf <- randomForest(
          y ~ ., data = df.temp %>% slice(sample(1:nrow(.), 1000)))
        predict(f.rf, df %>% filter(id == i), type = 'prob')[,'yes']
      }
  df$ynew[df$id==i] <- ifelse(
    (temp %>% apply(1, function(x) 1-mean(x)) %>% rank) %in% 1:5, 'yes', 'no')
  cat('\n')
}
stopCluster(cl)

df %>% 
  count(id,ynew) %>% 
  pivot_wider(names_from = ynew, values_from = n) %>% 
  mutate(yes = setNA(yes,0)) %>% arrange(yes)
## we correctly predicted 100% of the yeses for counties with 1-4 yeses --> good! 

sum(df$y=='yes')/nrow(df)
sum(df$ynew=='yes')/nrow(df)
table(df$y, df$ynew)

```

## SMOTE algorithm (DMwR)

```{r}
## without flipped yeses
df.smote <- 
  SMOTE(
    y ~ ., 
    data = df %>% mutate(id = factor(id)) %>% select(-ynew) %>% as.data.frame,
    perc.over = 200*nrow(df)/sum(df$y == 'yes'),
    perc.under = 100)

df.smote %>% 
  count(id,y) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(yes = setNA(yes,0)) %>% arrange(yes)

g1 <- df.smote %>% 
  mutate(id = toNumber(id)) %>%
  count(id) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = n)) + 
  ggtitle(waiver(), subtitle = 'number of AR events') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g2 <- df.smote %>% 
  mutate(id = toNumber(id)) %>%
  count(id,y) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(pct = setNA(yes/(yes+no),0)) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = pct)) + 
  ggtitle(waiver(), subtitle = 'probability of damaging event') + 
  scale_fill_scico(palette = 'davos', direction = -1)
g1 + g2 + plot_annotation(title = 'SMOTE without flipped yeses')

```

```{r}
## with flipped yeses
df.smote <- 
  SMOTE(
    ynew ~ ., 
    data = df %>% mutate(id = factor(id)) %>% select(-y) %>% as.data.frame,
    perc.over = 200*nrow(df)/sum(df$ynew == 'yes'),
    perc.under = 100)

df.smote %>% 
  count(id,ynew) %>% 
  pivot_wider(names_from = ynew, values_from = n) %>% 
  mutate(yes = setNA(yes,0)) %>% arrange(yes)

g1 <- df.smote %>% 
  mutate(id = toNumber(id)) %>%
  count(id) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = n)) + 
  ggtitle(waiver(), subtitle = 'number of AR events') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g2 <- df.smote %>% 
  mutate(id = toNumber(id)) %>%
  count(id,ynew) %>% 
  pivot_wider(names_from = ynew, values_from = n) %>% 
  mutate(pct = setNA(yes/(yes+no),0)) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = pct)) + 
  ggtitle(waiver(), subtitle = 'probability of damaging event') + 
  scale_fill_scico(palette = 'davos', direction = -1)
g1 + g2 + plot_annotation(title = 'SMOTE with flipped yeses')

```


## smote algorithm (themis)

```{r}
## without flipped yeses
df.smote <- smotenc(df %>% mutate(id = factor(id)) %>% select(-ynew), 'y')

df.smote %>% 
  count(id,y) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(yes = setNA(yes,0)) %>% arrange(yes)

g1 <- df.smote %>% 
  mutate(id = toNumber(id)) %>%
  count(id) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = n)) + 
  ggtitle(waiver(), subtitle = 'number of AR events') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g2 <- df.smote %>% 
  mutate(id = toNumber(id)) %>%
  count(id,y) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(pct = setNA(yes/(yes+no),0)) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = pct)) + 
  ggtitle(waiver(), subtitle = 'probability of damaging event') + 
  scale_fill_scico(palette = 'davos', direction = -1)
g1 + g2 + plot_annotation(title = 'SMOTE without flipped yeses')

```

```{r}
## with flipped yeses
df.smote <- smotenc(df %>% mutate(id = factor(id)) %>% select(-y), 'ynew')

df.smote %>% 
  count(id,ynew) %>% 
  pivot_wider(names_from = ynew, values_from = n) %>% 
  mutate(yes = setNA(yes,0)) %>% arrange(yes)

g1 <- df.smote %>% 
  mutate(id = toNumber(id)) %>%
  count(id) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = n)) + 
  ggtitle(waiver(), subtitle = 'number of AR events') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g2 <- df.smote %>% 
  mutate(id = toNumber(id)) %>%
  count(id,ynew) %>% 
  pivot_wider(names_from = ynew, values_from = n) %>% 
  mutate(pct = setNA(yes/(yes+no),0)) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = pct)) + 
  ggtitle(waiver(), subtitle = 'probability of damaging event') + 
  scale_fill_scico(palette = 'davos', direction = -1)
g1 + g2 + plot_annotation(title = 'SMOTE with flipped yeses')


```

# repeat for Sacramento

## unaltered data

```{r}
g1 <- catalog.df %>% 
  count(id) %>% 
  left_join(polys, ., by = 'id') %>% 
  arrange(desc(n)) %>% 
  ggplot() + 
  geom_sf(aes(fill = n)) + 
  ggtitle(waiver(), subtitle = 'number of AR events') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g2 <- catalog.df %>% 
  count(id, y = claims_num > 0) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(pct = setNA(`TRUE`/(`TRUE`+`FALSE`),0)) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = pct)) + 
  ggtitle(waiver(), subtitle = 'probability of damaging event') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g1 + g2 + plot_annotation(title = 'unaltered data')

```

## damaging events

```{r}
load('_data/_checkpoints/bg_0417.Rdata')

takeup.exp <- bg %>% st_drop_geometry %>% 
  transmute(county = COUNTYFP, tract = TRACTCE, pctarea = partarea/area, hu) %>% 
  filter(county == '067') %>% 
  mutate(policies.exp = 0.4*pctarea*hu + 0.01*(1-pctarea)*hu) %>% 
  group_by(tract) %>% 
  summarize(hu = sum(hu), policies.exp = sum(policies.exp)) %>% 
  ungroup %>% 
  left_join(
    policies.poly %>% filter(county == '06067') %>% count(tract, name = 'policies'),
    by = 'tract') %>%
  mutate(
    takeup.obs = setNA(policies/hu,0), 
    takeup.exp = setNA(policies.exp/hu,0))

```

```{r}
temp <- catalog.df %>% 
  count(id, y = claims_num>0) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  setNames(c('id','no','yes')) %>% 
  mutate(
    total = cbind(yes,no) %>% apply(1,Sum),
    pct_damaging = setNA(yes/total,0)) %>% 
  left_join(polys %>% st_drop_geometry %>% select(id,name), by = 'id') %>% 
  left_join(takeup.exp, by = c('name' = 'tract'))
  
g1 <- ggplot(temp) + 
  geom_point(aes(x = takeup.obs, y = pct_damaging)) +
  scale_x_origin('Tract Takeup Rate', labels = percent) + 
  scale_y_origin('Percent of Events with Damage', labels = percent) + 
  coord_cartesian(clip = 'off') + 
  theme(panel.grid.major = element_line(size = 0.25))
g2 <- ggplot(temp) + 
  geom_point(aes(x = setNA(policies,0), y = pct_damaging)) +
  scale_x_origin('Number of Policies', labels = comma_format(scale = 1e-3, suffix = 'K')) + 
  scale_y_origin('Percent of Events with Damage', labels = percent) + 
  coord_cartesian(clip = 'off') + 
  theme(panel.grid.major = element_line(size = 0.25))
g1 + g2 + plot_annotation('"damage": number of claims > 0')

```

```{r}
policies.median <- policies.poly %>% count(id) %>% pull(n) %>% median

temp2 <- catalog.df %>% 
  left_join(policies.poly %>% count(id, name = 'policies'), by = 'id') %>% 
  mutate(policies = setNA(policies,0)) %>% 
  count(id, y = claims_num>(policies/policies.median)) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  setNames(c('id','no','yes')) %>% 
  mutate(
    total = cbind(yes,no) %>% apply(1,Sum),
    pct_damaging = setNA(yes/total,0)) %>% 
  left_join(polys %>% st_drop_geometry %>% select(id,name), by = 'id') %>% 
  left_join(takeup.exp, by = c('name' = 'tract'))

g1 <- ggplot(temp2) + 
  geom_point(aes(x = takeup.obs, y = pct_damaging)) +
  scale_x_origin('Tract Takeup Rate', labels = percent) + 
  scale_y_origin('Percent of Events with Damage', labels = percent) + 
  coord_cartesian(clip = 'off') + 
  theme(panel.grid.major = element_line(size = 0.25))
g2 <- ggplot(temp2) + 
  geom_vline(xintercept = policies.median*1:4, color = 'grey70', linetype = 'dashed') +
  geom_point(aes(x = setNA(policies,0), y = pct_damaging)) +
  scale_x_origin('Number of Policies', labels = comma_format(scale = 1e-3, suffix = 'K')) + 
  scale_y_origin('Percent of Events with Damage', labels = percent) + 
  coord_cartesian(clip = 'off') + 
  ggtitle(waiver(), subtitle = 'excluding Sacramento') + 
  theme(panel.grid.major = element_line(size = 0.25))
g1 + g2 + plot_annotation(title = '"damage": number of claims > (# of policies)/(median policies)')

```

## observed vs. expected takeup 

```{r}
takeup.exp %>% arrange(desc(takeup.obs))

ggplot(takeup.exp) + 
  geom_vline(xintercept = 1, color = 'grey70') + 
  geom_point(aes(x = takeup.obs, y = takeup.exp)) + 
  scale_x_origin('Observed Tract Takeup Rate', labels = percent, breaks = 0.1*(0:50)) + 
  scale_y_origin('Theoretical Tract Takeup Rate', labels = percent, breaks = 0.1*(0:50)) + 
  geom_parity() + #coord_fixed() + 
  theme(panel.grid.major = element_line(size = 0.25))

```

# next 

why are the county-level results so weird? what's going on with Humboldt County? 

## unaltered data 

```{r}
g1 <- catalog.df %>% 
  count(id) %>% 
  left_join(polys, ., by = 'id') %>% 
  arrange(desc(n)) %>% 
  ggplot() + 
  geom_sf(aes(fill = n)) + 
  ggtitle(waiver(), subtitle = 'number of AR events') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g2 <- catalog.df %>% 
  count(id, y = claims_num > 0) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(pct = setNA(`TRUE`/(`TRUE`+`FALSE`),0)) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = pct)) + 
  ggtitle(waiver(), subtitle = 'probability of damaging event') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g1 + g2 + plot_annotation(title = 'unaltered data')

```

```{r}
g1 <- df.train %>% 
  count(id) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = n)) + 
  ggtitle(waiver(), subtitle = 'number of AR events') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g2 <- df.train %>% 
  count(id,y) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(pct = setNA(yes/(yes+no),0)) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = pct)) + 
  ggtitle(waiver(), subtitle = 'probability of damaging event') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g1 + g2 + plot_annotation(title = 'training data')

```

```{r}
g1 <- df.pca %>% 
  mutate(id = obs.id$id) %>% 
  count(id) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = n)) + 
  ggtitle(waiver(), subtitle = 'number of AR events') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g2 <- df.pca %>% 
  mutate(id = obs.id$id) %>% 
  count(id,y) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(pct = setNA(yes/(yes+no),0)) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = pct)) + 
  ggtitle(waiver(), subtitle = 'probability of damaging event') + 
  scale_fill_scico(palette = 'davos', direction = -1)
g1 + g2 + plot_annotation(title = 'post-SMOTE data')

```

## normal SMOTE based on class imbalance

```{r}
data <- df.train %>% 
  mutate(
    cat = factor(cat, levels = 5:1), 
    CRS = factor(CRS, levels = 10:2), 
    disasters = factor(disasters),
    id = factor(id)) %>% as.data.frame
ratio <- sum(data$y=='yes')/nrow(data)

df.smote <- SMOTE(
  y ~ ., data = data, 
  perc.over = 100/ratio,  # minority oversampling percentage
  perc.under = 100,       # majority undersampling percentage
  k = 5)   # KNN used to generate new examples of minority class

g1 <- df.smote %>% 
  mutate(id = toNumber(id)) %>%
  count(id) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = n)) + 
  ggtitle(waiver(), subtitle = 'number of AR events') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g2 <- df.smote %>% 
  mutate(id = toNumber(id)) %>%
  count(id,y) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(pct = setNA(yes/(yes+no),0)) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = pct)) + 
  ggtitle(waiver(), subtitle = 'probability of damaging event') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g1 + g2 + plot_annotation(title = 'SMOTE based on class imbalance')

```

## regionalized SMOTE based on class imbalance

```{r}
df.smote <- 
  foreach (q = paste0('q',1:5), .combine = 'rbind') %do% {
    data <- df.train %>% 
      mutate(
        cat = factor(cat, levels = 5:1), 
        CRS = factor(CRS, levels = 10:2), 
        disasters = factor(disasters),
        id = factor(id)) %>% 
      filter(id %in% takeup$id[takeup$bucket==q]) %>% 
      mutate(bucket = factor(q)) %>% as.data.frame
    SMOTE(
      y ~ ., data = data, 
      perc.over = 100/ratio,  # minority oversampling percentage
      perc.under = 200,       # majority undersampling percentage
      k = 5)   # KNN used to generate new examples of minority class
  }
vars <- names(df.train)[names(df.train) != 'y' & names(df.train) != 'id']
# df.smote <- 
df.smote %>% 
  select(-id) %>% 
  mutate(
    cat = toNumber(cat), 
    CRS = toNumber(CRS), 
    disasters = toNumber(disasters)) %>% 
  filter(complete.cases(.)) %>% 
  left_join(df.train %>% select(-y), by = vars) %>% View
  group_by(bucket) %>% 
  mutate(id = ifelse(is.na(id), sample(id[!is.na(id)], sum.na(id), replace = TRUE), id)) %>% 
  ungroup %>% select(-bucket)

g1 <- df.smote %>% 
  mutate(id = toNumber(id)) %>%
  count(id) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = n)) + 
  ggtitle(waiver(), subtitle = 'number of AR events') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g2 <- df.smote %>% 
  mutate(id = toNumber(id)) %>%
  count(id,y) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(pct = setNA(yes/(yes+no),0)) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = pct)) + 
  ggtitle(waiver(), subtitle = 'probability of damaging event') + 
  scale_fill_scico(palette = 'davos', direction = -1)
g1 + g2 + plot_annotation(title = 'regionalized SMOTE based on class imbalance')

```

## regionalized SMOTE based on takeup rates

```{r}
df.smote <- 
  foreach (q = paste0('q',1:5), .combine = 'rbind') %do% {
    data <- df.train %>% 
      mutate(
        cat = factor(cat, levels = 5:1), 
        CRS = factor(CRS, levels = 10:2), 
        disasters = factor(disasters),
        id = factor(id)) %>% 
      filter(id %in% takeup$id[takeup$bucket==q]) %>% 
      mutate(bucket = factor(q)) %>% as.data.frame
    SMOTE(
      y ~ ., data = data, 
      perc.over = 25/takeup$newtakeup[takeup$bucket==q][1],  # minority oversampling percentage
      perc.under = 200,       # majority undersampling percentage
      k = 25)   # KNN used to generate new examples of minority class
  }
vars <- names(df.train)[names(df.train) != 'y' & names(df.train) != 'id']
df.smote <- df.smote %>% 
  mutate(
    cat = toNumber(cat), 
    CRS = toNumber(CRS), 
    disasters = toNumber(disasters)) %>% 
  select(-id) %>% 
  filter(complete.cases(.)) %>% 
  left_join(df.train %>% select(-y), by = vars) %>% 
  group_by(bucket) %>% 
  mutate(id = ifelse(is.na(id), sample(id[!is.na(id)], sum.na(id), replace = TRUE), id)) %>% 
  ungroup %>% select(-bucket)

g1 <- df.smote %>% 
  mutate(id = toNumber(id)) %>%
  count(id) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = n)) + 
  ggtitle(waiver(), subtitle = 'number of AR events') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g2 <- df.smote %>% 
  mutate(id = toNumber(id)) %>%
  count(id,y) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(pct = setNA(yes/(yes+no),0)) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = pct)) + 
  ggtitle(waiver(), subtitle = 'probability of damaging event') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0.25, 0.6))
g1 + g2 + plot_annotation(title = 'regionalized SMOTE based on takeup rates (k=25)')

```

## how do I get the same number of events?

```{r}
df.smote <- 
  foreach (q = paste0('q',1:5), .combine = 'rbind') %do% {
    data <- df.train %>% 
      mutate(
        cat = factor(cat, levels = 5:1), 
        CRS = factor(CRS, levels = 10:2), 
        disasters = factor(disasters),
        id = factor(id)) %>% 
      filter(id %in% takeup$id[takeup$bucket==q]) %>% 
      mutate(bucket = factor(q)) %>% as.data.frame
    SMOTE(
      y ~ ., data = data, 
      perc.over = 50/takeup$newtakeup[takeup$bucket==q][1],  # minority oversampling percentage
      perc.under = 150,      # majority undersampling percentage
      k = 5)   # KNN used to generate new examples of minority class
  }
vars <- names(df.train)[names(df.train) != 'y' & names(df.train) != 'id']
df.smote <- df.smote %>% 
  mutate(
    cat = toNumber(cat), 
    CRS = toNumber(CRS), 
    disasters = toNumber(disasters)) %>% 
  select(-id) %>% 
  filter(complete.cases(.)) %>% 
  left_join(df.train %>% select(-y), by = vars) %>% 
  group_by(bucket) %>% 
  mutate(id = ifelse(is.na(id), sample(id[!is.na(id)], sum.na(id), replace = TRUE), id)) %>% 
  ungroup %>% select(-bucket)

## remove extraneous events
df.smote %>% 
  count(id, name = 'n.smote') %>% 
  left_join(df.train %>% count(id, name = 'n.train'), by = 'id') %>% 
  mutate(diff = n.smote/n.train) %>% arrange(diff) %>% 
  mutate(n.final = round(n.smote*diff[1]/diff)) %>% 

sample(1:nrow(polys), nrow(df.smote), prob = df.train %>% count(id) %>% pull(n), replace = TRUE)

g1 <- df.smote %>% 
  mutate(id = toNumber(id)) %>%
  count(id) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = n)) + 
  ggtitle(waiver(), subtitle = 'number of AR events') + 
  scale_fill_scico(palette = 'davos', direction = -1, limits = c(0,NA))
g2 <- df.smote %>% 
  mutate(id = toNumber(id)) %>%
  count(id,y) %>% 
  pivot_wider(names_from = y, values_from = n) %>% 
  mutate(pct = setNA(yes/(yes+no),0)) %>% 
  left_join(polys, ., by = 'id') %>% 
  ggplot() + 
  geom_sf(aes(fill = pct)) + 
  ggtitle(waiver(), subtitle = 'probability of damaging event') + 
  scale_fill_scico(palette = 'davos', direction = -1)
g1 + g2 + plot_annotation(title = 'regionalized SMOTE based on takeup rates')

```


```{r}
df.smote %>% 
  left_join(polys %>% st_drop_geometry %>% select(id,name), by = 'id') %>% 
  left_join(california %>% st_drop_geometry %>% select(COUNTYFP,NAME), by = c('name' = 'NAME')) %>%
  count(COUNTYFP, name = 'n.smote') %>% 
  left_join(takeup.exp %>% select(county, policies.exp), by = c('COUNTYFP' = 'county'))


```

# can I calculate TreeSHAP values instead of Shapley?

```{r}
require(shapper)
install_shap()

install.packages('DALEX')

```

